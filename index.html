<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="美容室在庫管理">
    <meta name="theme-color" content="#ec4899">
    <title>美容室在庫管理システム - クラウド版</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src='https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js'></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #fdf2f8 0%, #f3e8ff 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .cloud-status {
            position: absolute;
            top: 20px;
            left: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        .cloud-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }
        
        .cloud-indicator.offline {
            background: #dc2626;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .user-info {
            position: absolute;
            top: 20px;
            right: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-info span {
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        .save-btn {
            background: rgba(16, 185, 129, 0.9);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .save-btn:hover {
            background: rgba(16, 185, 129, 1);
            border-color: rgba(255,255,255,0.5);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
        }
        
        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        
        .nav-tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .nav-tab:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }
        
        .nav-tab.active {
            background: white;
            color: #ec4899;
            border-bottom: 3px solid #ec4899;
        }
        
        .content {
            padding: 30px;
            min-height: 600px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            padding: 25px;
            border-radius: 15px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card.pink {
            background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%);
        }
        
        .stat-card.blue {
            background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%);
        }
        
        .stat-card.green {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .stat-card.orange {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .stat-info h3 {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        
        .stat-info .number {
            font-size: 2.5rem;
            font-weight: bold;
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            opacity: 0.8;
        }
        
        .table-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-top: 20px;
        }
        
        .table-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-header h3 {
            color: #495057;
            font-size: 1.3rem;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-critical {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .status-low {
            background: #fef3c7;
            color: #d97706;
        }
        
        .status-optimal {
            background: #d1fae5;
            color: #059669;
        }
        
        .status-excess {
            background: #dbeafe;
            color: #2563eb;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(236, 72, 153, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.3);
        }
        
        .alert {
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #dc2626;
            background: #fef2f2;
            color: #7f1d1d;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            padding: 25px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 25px;
        }
        
        .upload-zone {
            border: 2px dashed #d1d5db;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-zone:hover {
            border-color: #8b5cf6;
            background: #f9fafb;
        }
        
        .upload-zone.dragover {
            border-color: #8b5cf6;
            background: #f3e8ff;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .form-control {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #8b5cf6;
        }
        
        .csv-preview {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .error-list {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .error-item {
            color: #dc2626;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .hidden {
            display: none;
        }
        
        .flex {
            display: flex;
        }
        
        .justify-between {
            justify-content: space-between;
        }
        
        .gap-10 {
            gap: 10px;
        }
        
        .text-right {
            text-align: right;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }

        /* ログイン画面 */
        .login-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #fdf2f8 0%, #f3e8ff 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .login-box {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-header h1 {
            background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .login-form input {
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .login-form input:focus {
            outline: none;
            border-color: #8b5cf6;
        }
        
        .login-btn {
            background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%);
            color: white;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(236, 72, 153, 0.3);
        }

        /* Firebase設定モーダル */
        .firebase-setup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .firebase-setup-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .setup-step {
            margin-bottom: 25px;
            padding: 20px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
        }
        
        .setup-step h3 {
            color: #ec4899;
            margin-bottom: 15px;
        }
        
        .config-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: monospace;
            font-size: 0.9rem;
            background: #f8f9fa;
        }

        /* 削除確認モーダル */
        .confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .confirm-modal.show {
            display: flex;
        }
        
        .confirm-content {
            background: white;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            padding: 30px;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        }
        
        .confirm-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }
        
        .confirm-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #dc2626;
        }
        
        .confirm-message {
            margin-bottom: 25px;
            color: #6c757d;
            line-height: 1.6;
        }
        
        .confirm-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        /* 取引詳細モーダル */
        .transaction-details {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .transaction-item:last-child {
            border-bottom: none;
        }
        
        .transaction-item:hover {
            background: #f8f9fa;
        }

        /* 同期ステータス */
        .sync-status {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .sync-status.show {
            opacity: 1;
        }

        /* ユーザー設定タブ */
        .settings-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .settings-section h3 {
            margin-bottom: 20px;
            color: #495057;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
        }

        /* クリック可能なスタイル */
        .clickable {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .clickable:hover {
            color: #8b5cf6;
            text-decoration: underline;
        }

        /* パスワード変更モーダル */
        .password-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1500;
        }
        
        .password-modal.show {
            display: flex;
        }
        
        .password-modal-content {
            background: white;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            padding: 30px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        }
        
        .password-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        
        .password-form input {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .password-form input:focus {
            outline: none;
            border-color: #8b5cf6;
        }
        
        .password-error {
            color: #dc2626;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .password-success {
            color: #10b981;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        /* OCR関連のスタイル */
        .ocr-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1500;
            overflow-y: auto;
        }
        
        .ocr-modal.show {
            display: flex;
        }
        
        .ocr-modal-content {
            background: white;
            border-radius: 15px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        }
        
        .ocr-options {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
        }
        
        .ocr-preview {
            max-width: 100%;
            margin: 20px 0;
            text-align: center;
        }
        
        .ocr-preview img {
            max-width: 100%;
            max-height: 400px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
        }
        
        .ocr-results {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .ocr-confirm-table {
            width: 100%;
            margin: 15px 0;
        }
        
        .ocr-confirm-table td {
            padding: 10px;
            vertical-align: middle;
        }
        
        .ocr-confirm-table input {
            width: 80px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }
        
        .ocr-loading {
            text-align: center;
            padding: 40px;
        }
        
        .ocr-loading-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #8b5cf6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .ocr-template {
            background: white;
            padding: 30px;
            font-family: 'メイリオ', 'Meiryo', sans-serif;
            font-size: 16pt;
            line-height: 2.5;
            color: black;
        }
        
        .ocr-template h2 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 24pt;
        }
        
        .ocr-template .ocr-item {
            margin: 15px 0;
            font-size: 18pt;
        }
        
        .ocr-template .checkbox {
            display: inline-block;
            width: 25px;
            height: 25px;
            border: 3px solid black;
            margin-right: 15px;
            vertical-align: middle;
        }
        
        .ocr-staff-select {
            margin: 20px 0;
            text-align: center;
        }
        
        .ocr-staff-select select {
            padding: 10px 20px;
            font-size: 1.1rem;
            border: 2px solid #8b5cf6;
            border-radius: 8px;
            background: white;
        }

        /* モバイル対応 */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                margin: 0;
                border-radius: 10px;
            }
            
            .header {
                padding: 20px 15px;
                position: relative;
            }
            
            .header h1 {
                font-size: 1.8rem;
                margin-bottom: 5px;
            }
            
            .header p {
                font-size: 0.9rem;
            }
            
            .cloud-status {
                position: static;
                justify-content: center;
                margin-bottom: 15px;
                gap: 10px;
            }
            
            .user-info {
                position: static;
                justify-content: center;
                margin-bottom: 15px;
                gap: 10px;
            }
            
            .nav-tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                white-space: nowrap;
            }
            
            .nav-tab {
                flex: none;
                min-width: 120px;
                padding: 15px 10px;
                font-size: 0.95rem;
            }
            
            .content {
                padding: 20px 15px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
                margin-bottom: 20px;
            }
            
            .stat-card {
                padding: 20px 15px;
            }
            
            .stat-info .number {
                font-size: 2rem;
            }
            
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            table {
                min-width: 600px;
                font-size: 0.9rem;
            }
            
            th, td {
                padding: 10px 8px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .modal-content {
                width: 95%;
                margin: 20px;
                max-height: 85vh;
            }
            
            .modal-body {
                padding: 20px 15px;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 15px 10px;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .header p {
                font-size: 0.8rem;
            }
            
            .user-info {
                flex-direction: column;
                gap: 8px;
            }
            
            .save-btn, .logout-btn {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
            
            .nav-tab {
                min-width: 100px;
                padding: 12px 8px;
                font-size: 0.85rem;
            }
            
            .content {
                padding: 15px 10px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .stat-card {
                padding: 15px;
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            
            .stat-info .number {
                font-size: 1.8rem;
            }
            
            .stat-icon {
                width: 40px;
                height: 40px;
            }
            
            .btn {
                padding: 10px 16px;
                font-size: 0.9rem;
                margin-bottom: 5px;
            }
            
            .flex.justify-between {
                flex-direction: column;
                gap: 10px;
            }
            
            .flex.gap-10 {
                flex-direction: column;
                gap: 8px;
            }
            
            table {
                font-size: 0.8rem;
                min-width: 500px;
            }
            
            th, td {
                padding: 8px 6px;
            }
            
            .form-control {
                padding: 10px;
                font-size: 0.9rem;
            }
            
            .alert {
                padding: 15px;
                font-size: 0.9rem;
            }
            
            .login-box {
                padding: 30px 20px;
                margin: 10px;
            }
            
            .login-header h1 {
                font-size: 1.6rem;
            }
            
            .login-form input {
                padding: 12px;
                font-size: 0.9rem;
            }
            
            .login-btn {
                padding: 12px;
                font-size: 1rem;
            }
            
            .settings-section {
                padding: 20px 15px;
            }
            
            .settings-section h3 {
                font-size: 1.1rem;
            }
            
            .modal-content {
                width: 98%;
                margin: 10px;
                max-height: 90vh;
            }
            
            .modal-header {
                padding: 20px 15px;
            }
            
            .modal-header h2 {
                font-size: 1.3rem;
            }
            
            .confirm-content {
                padding: 25px 20px;
                margin: 10px;
            }
            
            .confirm-title {
                font-size: 1.3rem;
            }
            
            .confirm-icon {
                font-size: 3rem;
            }
        }
    </style>
</head>
<body>
    <!-- Firebase設定モーダル -->
    <div id="firebaseSetup" class="firebase-setup">
        <div class="firebase-setup-content">
            <h2 style="text-align: center; margin-bottom: 30px; color: #ec4899;">🔥 Firebase設定</h2>
            
            <div class="setup-step">
                <h3>ステップ1: Firebaseプロジェクト作成</h3>
                <p>1. <a href="https://console.firebase.google.com/" target="_blank">Firebase Console</a>にアクセス</p>
                <p>2. 「プロジェクトを作成」をクリック</p>
                <p>3. プロジェクト名: 「美容室在庫管理」</p>
                <p>4. Firestoreデータベースを有効化</p>
            </div>
            
            <div class="setup-step">
                <h3>ステップ2: Web アプリを追加</h3>
                <p>1. プロジェクト設定 → 全般</p>
                <p>2. 「アプリを追加」→ Web アイコン</p>
                <p>3. アプリ名: 「美容室在庫管理」</p>
                <p>4. 設定オブジェクトをコピー</p>
            </div>
            
            <div class="setup-step">
                <h3>ステップ3: 設定を貼り付け</h3>
                <textarea id="firebaseConfig" class="config-input" rows="10" placeholder="Firebase設定オブジェクトを貼り付けてください...

例:
{
  apiKey: &quot;your-api-key&quot;,
  authDomain: &quot;your-project.firebaseapp.com&quot;,
  projectId: &quot;your-project-id&quot;,
  storageBucket: &quot;your-project.appspot.com&quot;,
  messagingSenderId: &quot;123456789&quot;,
  appId: &quot;your-app-id&quot;
}"></textarea>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-primary" onclick="setupFirebase()">🚀 設定完了</button>
                <button class="btn" onclick="useLocalStorage()" style="background: #6c757d; color: white; margin-left: 10px;">📱 ローカルで使用</button>
            </div>
        </div>
    </div>

    <!-- ログイン画面 -->
    <div id="loginContainer" class="login-container" style="display: none;">
        <div class="login-box">
            <div class="login-header">
                <h1>美容室在庫管理 ☁️</h1>
                <p style="color: #6c757d;">クラウド同期版</p>
            </div>
            <form class="login-form" onsubmit="return login(event)">
                <input type="text" id="loginUsername" placeholder="ユーザー名" required value="admin">
                <input type="password" id="loginPassword" placeholder="パスワード" required value="password">
                <button type="submit" class="login-btn">ログイン</button>
            </form>
            <div style="text-align: center; margin-top: 20px; color: #6c757d; font-size: 0.9rem;">
                <strong>デモ用アカウント</strong><br>
                ユーザー名: admin<br>
                パスワード: password<br>
                <small>（データはクラウドに同期されます）</small>
            </div>
        </div>
    </div>

    <!-- メインアプリケーション -->
    <div id="mainApp" class="container" style="display: none;">
        <!-- ヘッダー -->
        <div class="header">
            <div class="cloud-status">
                <div class="cloud-indicator" id="cloudIndicator"></div>
                <span id="cloudStatus">クラウド同期中...</span>
            </div>
            <div class="user-info">
                <button class="save-btn" onclick="saveToCloud()">
                    ☁️ クラウド保存
                </button>
                <span id="currentUserName">👤 admin</span>
                <button class="logout-btn" onclick="logout()">ログアウト</button>
            </div>
            <h1>美容室在庫管理システム ☁️</h1>
            <p>プロフェッショナル美容室向け総合在庫管理 - クラウド同期版</p>
        </div>

        <!-- ナビゲーションタブ -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">
                📊 ダッシュボード
            </button>
            <button class="nav-tab" onclick="showTab('products')">
                📦 商品マスタ
            </button>
            <button class="nav-tab" onclick="showTab('staff')">
                👥 スタッフマスタ
            </button>
            <button class="nav-tab" onclick="showTab('transactions')">
                📋 取引記録
            </button>
            <button class="nav-tab" onclick="showTab('reports')">
                📈 月次レポート
            </button>
            <button class="nav-tab" onclick="showTab('settings')">
                ⚙️ 設定
            </button>
        </div>

        <!-- コンテンツエリア -->
        <div class="content">
            <!-- ダッシュボードタブ -->
            <div id="dashboard" class="tab-content active">
                <!-- 統計カード -->
                <div class="stats-grid">
                    <div class="stat-card pink">
                        <div class="stat-info">
                            <h3>総商品数</h3>
                            <div class="number" id="dashboard-total-products">12</div>
                        </div>
                        <div class="stat-icon">📦</div>
                    </div>
                    <div class="stat-card orange">
                        <div class="stat-info">
                            <h3>要注意在庫</h3>
                            <div class="number" id="dashboard-warning-stock">3</div>
                        </div>
                        <div class="stat-icon">⚠️</div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-info">
                            <h3>適正在庫</h3>
                            <div class="number" id="dashboard-optimal-stock">8</div>
                        </div>
                        <div class="stat-icon">✅</div>
                    </div>
                    <div class="stat-card blue">
                        <div class="stat-info">
                            <h3>棚卸し金額</h3>
                            <div class="number" id="dashboard-inventory-value">¥234K</div>
                        </div>
                        <div class="stat-icon">💰</div>
                    </div>
                </div>

                <!-- アラート -->
                <div class="alert" id="stock-alert">
                    <strong>⚠️ 在庫不足商品があります</strong><br>
                    <span id="alert-details">緊急: 1品目, 要注意: 2品目の商品で在庫が不足しています。早急な発注をご検討ください。</span>
                </div>

                <!-- 在庫状況テーブル -->
                <div class="table-container">
                    <div class="table-header">
                        <h3>在庫状況一覧（クラウド同期）</h3>
                        <button class="btn btn-secondary" onclick="loadCloudData()">🔄 最新データ取得</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>商品名</th>
                                <th>現在庫</th>
                                <th>適正在庫</th>
                                <th>差異</th>
                                <th>ステータス</th>
                                <th>在庫金額</th>
                            </tr>
                        </thead>
                        <tbody id="dashboard-stock-table">
                            <!-- 動的に生成される -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 商品マスタタブ -->
            <div id="products" class="tab-content">
                <div class="flex justify-between" style="margin-bottom: 20px;">
                    <h2>商品マスタ管理（クラウド同期）</h2>
                    <div class="flex gap-10">
                        <button class="btn btn-secondary" onclick="showCsvModal('products')">
                            📤 CSV一括登録
                        </button>
                        <button class="btn btn-primary" onclick="showAddProductForm()">
                            ➕ 商品追加
                        </button>
                    </div>
                </div>

                <!-- 商品追加フォーム -->
                <div id="addProductForm" class="table-container hidden" style="margin-bottom: 20px;">
                    <div class="table-header">
                        <h3>新しい商品を追加</h3>
                    </div>
                    <div style="padding: 20px;">
                        <div class="form-grid">
                            <input type="text" class="form-control" placeholder="商品名" id="productName">
                            <input type="number" class="form-control" placeholder="適正在庫数" id="optimalStock">
                            <input type="number" class="form-control" placeholder="単価" id="unitPrice">
                            <input type="text" class="form-control" placeholder="仕入先 *必須" id="supplier">
                            <select class="form-control" id="category">
                                <option value="カラー剤">カラー剤</option>
                                <option value="シャンプー">シャンプー</option>
                                <option value="トリートメント">トリートメント</option>
                                <option value="パーマ液">パーマ液</option>
                                <option value="スタイリング">スタイリング</option>
                                <option value="その他">その他</option>
                            </select>
                        </div>
                        <div class="flex gap-10">
                            <button class="btn btn-primary" onclick="addProduct()">追加</button>
                            <button class="btn" onclick="hideAddProductForm()" style="background: #6c757d; color: white;">キャンセル</button>
                        </div>
                    </div>
                </div>

                <!-- 商品一覧テーブル -->
                <div class="table-container">
                    <div class="table-header">
                        <h3>商品一覧</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>商品名</th>
                                <th>カテゴリ</th>
                                <th>現在庫</th>
                                <th>適正在庫</th>
                                <th>単価</th>
                                <th>仕入先</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody">
                            <!-- 動的に生成される -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- スタッフマスタタブ -->
            <div id="staff" class="tab-content">
                <div class="flex justify-between" style="margin-bottom: 20px;">
                    <h2>スタッフマスタ管理（クラウド同期）</h2>
                    <button class="btn btn-secondary" onclick="showCsvModal('staff')">
                        📤 CSV一括登録
                    </button>
                </div>

                <div class="table-container">
                    <div class="table-header">
                        <h3>スタッフ一覧</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>スタッフコード</th>
                                <th>氏名</th>
                                <th>役職</th>
                                <th>在籍状況</th>
                                <th>入社日</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="staffTableBody">
                            <!-- 動的に生成される -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 取引記録タブ -->
            <div id="transactions" class="tab-content">
                <div class="flex justify-between" style="margin-bottom: 20px;">
                    <h2>取引記録（リアルタイム同期）</h2>
                    <div class="flex gap-10">
                        <button class="btn btn-secondary" onclick="showOCRModal()">📸 紙の記録を読み取り</button>
                        <button class="btn btn-primary" onclick="showAddTransactionForm()">➕ 取引追加</button>
                    </div>
                </div>

                <!-- 取引追加フォーム -->
                <div id="addTransactionForm" class="table-container hidden" style="margin-bottom: 20px;">
                    <div class="table-header">
                        <h3>新しい取引を追加</h3>
                    </div>
                    <div style="padding: 20px;">
                        <div class="form-grid">
                            <select class="form-control" id="transactionProduct">
                                <option value="">商品を選択</option>
                            </select>
                            <select class="form-control" id="transactionType">
                                <option value="order">発注</option>
                                <option value="receipt">入荷</option>
                                <option value="use">使用</option>
                                <option value="sale">販売</option>
                            </select>
                            <input type="number" class="form-control" placeholder="数量" id="transactionQuantity">
                            <select class="form-control" id="transactionStaff">
                                <option value="">担当者を選択</option>
                            </select>
                            <input type="text" class="form-control" placeholder="メモ" id="transactionMemo">
                        </div>
                        <div class="flex gap-10">
                            <button class="btn btn-primary" onclick="addTransaction()">追加</button>
                            <button class="btn" onclick="hideAddTransactionForm()" style="background: #6c757d; color: white;">キャンセル</button>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <div class="table-header">
                        <h3>最近の取引履歴</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>日付・時刻</th>
                                <th>商品</th>
                                <th>種別</th>
                                <th>数量</th>
                                <th>担当者</th>
                                <th>メモ</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsTableBody">
                            <!-- 動的に生成される -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 月次レポートタブ -->
            <div id="reports" class="tab-content">
                <h2 style="margin-bottom: 20px;">月次レポート（クラウド集計）</h2>
                
                <div class="stats-grid" style="margin-bottom: 30px;">
                    <div class="stat-card blue">
                        <div class="stat-info">
                            <h3>当月発注額</h3>
                            <div class="number" id="monthly-amount">¥0</div>
                        </div>
                        <div class="stat-icon">💰</div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-info">
                            <h3>仕入先数</h3>
                            <div class="number" id="supplier-count">0</div>
                        </div>
                        <div class="stat-icon">🏢</div>
                    </div>
                    <div class="stat-card orange">
                        <div class="stat-info">
                            <h3>取引件数</h3>
                            <div class="number clickable" id="transaction-count" onclick="showTransactionDetails()">0</div>
                        </div>
                        <div class="stat-icon">📋</div>
                    </div>
                    <div class="stat-card pink">
                        <div class="stat-info">
                            <h3>最新更新</h3>
                            <div class="number" id="last-update" style="font-size: 1.2rem;">リアルタイム</div>
                        </div>
                        <div class="stat-icon">🔄</div>
                    </div>
                </div>

                <div class="table-container">
                    <div class="table-header">
                        <h3>仕入先別発注集計（リアルタイム更新）</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>仕入先</th>
                                <th>金額</th>
                                <th>割合</th>
                                <th>取引回数</th>
                                <th>平均単価</th>
                            </tr>
                        </thead>
                        <tbody id="supplier-report-tbody">
                            <!-- 動的に生成される -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 設定タブ -->
            <div id="settings" class="tab-content">
                <h2 style="margin-bottom: 20px;">ユーザー設定（クラウド版）</h2>

                <!-- アカウント設定セクション -->
                <div class="settings-section">
                    <h3>👤 アカウント設定</h3>
                    <div style="margin-top: 20px;">
                        <div style="margin-bottom: 15px;">
                            <strong>ユーザー名:</strong> <span id="settingsUsername">admin</span>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <strong>表示名:</strong> <span id="settingsDisplayName">管理者</span>
                        </div>
                        <div style="margin-top: 20px;">
                            <button class="btn btn-primary" onclick="showPasswordModal()">🔐 パスワード変更</button>
                        </div>
                    </div>
                </div>

                <!-- クラウド設定 -->
                <div class="settings-section">
                    <h3>☁️ クラウド設定</h3>
                    <div style="margin-top: 20px;">
                        <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                            <button class="btn btn-primary" onclick="forceSync()">🔄 強制同期</button>
                            <button class="btn" onclick="clearCloudData()" style="background: #dc2626; color: white;">🗑️ クラウドデータ削除</button>
                        </div>
                        
                        <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <h4>📊 同期統計</h4>
                            <div style="margin-top: 10px; font-size: 0.9rem;">
                                <div>最終同期: <span id="lastSync">未同期</span></div>
                                <div>プロジェクトID: <span id="projectId">未設定</span></div>
                                <div>同期状態: <span id="syncState">初期化中</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- データ管理 -->
                <div class="settings-section">
                    <h3>💾 データ管理</h3>
                    <div style="display: grid; gap: 15px;">
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <button class="btn btn-primary" onclick="exportData()">
                                📤 データエクスポート
                            </button>
                            <span style="color: #6c757d; font-size: 0.9rem;">現在のデータをJSONファイルで保存</span>
                        </div>
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <button class="btn btn-secondary" onclick="importData()">
                                📥 データインポート
                            </button>
                            <span style="color: #6c757d; font-size: 0.9rem;">JSONファイルからデータを復元</span>
                        </div>
                    </div>
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <h4 style="margin-bottom: 10px;">📊 データ統計</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; font-size: 0.9rem;">
                            <div>📦 商品マスタ: <strong id="stats-products">0</strong>件</div>
                            <div>👥 スタッフマスタ: <strong id="stats-staff">0</strong>件</div>
                            <div>📋 取引記録: <strong id="stats-transactions">0</strong>件</div>
                            <div>💾 最終保存: <strong id="stats-last-save">未保存</strong></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- パスワード変更モーダル -->
    <div id="passwordModal" class="password-modal">
        <div class="password-modal-content">
            <div class="modal-header">
                <h2>🔐 パスワード変更</h2>
                <button onclick="closePasswordModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">✕</button>
            </div>
            <div class="modal-body">
                <form class="password-form" onsubmit="return changePassword(event)">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">現在のパスワード</label>
                        <input type="password" id="currentPassword" required placeholder="現在のパスワードを入力">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">新しいパスワード</label>
                        <input type="password" id="newPassword" required placeholder="新しいパスワードを入力" minlength="6">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">新しいパスワード（確認）</label>
                        <input type="password" id="confirmPassword" required placeholder="新しいパスワードを再入力">
                    </div>
                    <div id="passwordError" class="password-error" style="display: none;"></div>
                    <div id="passwordSuccess" class="password-success" style="display: none;"></div>
                    <div class="flex gap-10" style="margin-top: 20px;">
                        <button type="submit" class="btn btn-primary">変更</button>
                        <button type="button" class="btn" onclick="closePasswordModal()" style="background: #6c757d; color: white;">キャンセル</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- CSV一括登録モーダル -->
    <div id="csvModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>CSV一括登録（クラウド同期）</h2>
                <button onclick="closeCsvModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">✕</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <h3>ステップ1: データ種別を選択</h3>
                    <div class="flex gap-10" style="margin-top: 10px;">
                        <button id="productTypeBtn" class="btn btn-primary" onclick="setCsvType('products')">商品マスタ</button>
                        <button id="staffTypeBtn" class="btn" onclick="setCsvType('staff')" style="background: #6c757d; color: white;">スタッフマスタ</button>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <h3>ステップ2: CSVテンプレートをダウンロード</h3>
                    <button class="btn btn-secondary" onclick="downloadTemplate()">
                        📥 CSVテンプレートダウンロード
                    </button>
                    <p style="margin-top: 10px; color: #6c757d; font-size: 0.9rem;" id="templateInfo">
                        商品マスタ必須項目: name(商品名), currentStock(現在庫), optimalStock(適正在庫), supplier(仕入れ先) ※unitPrice(単価)は空白可
                    </p>
                </div>

                <div style="margin-bottom: 20px;">
                    <h3>ステップ3: CSVファイルをアップロード</h3>
                    <div class="upload-zone" id="uploadZone" onclick="document.getElementById('csvFile').click()">
                        <div style="font-size: 3rem; margin-bottom: 10px;">📤</div>
                        <p style="font-size: 1.1rem; margin-bottom: 10px;">CSVファイルをドラッグ&ドロップ</p>
                        <p style="color: #6c757d; margin-bottom: 10px;">または</p>
                        <button class="btn btn-secondary">ファイルを選択</button>
                    </div>
                    <input type="file" id="csvFile" accept=".csv" style="display: none;" onchange="handleFileSelect(event)">
                </div>

                <div id="csvPreview" class="hidden">
                    <h3>データプレビュー</h3>
                    <div id="errorSummary" class="error-list hidden">
                        <strong>⚠️ エラーが見つかりました</strong>
                        <div id="errorDetails"></div>
                    </div>
                    <div class="csv-preview">
                        <table id="previewTable">
                            <thead id="previewHeader"></thead>
                            <tbody id="previewBody"></tbody>
                        </table>
                    </div>
                    <div class="flex justify-between" style="margin-top: 20px;">
                        <button class="btn" onclick="clearCsvData()" style="background: #6c757d; color: white;">クリア</button>
                        <button class="btn btn-primary" id="importBtn" onclick="importCsvData()">
                            <span id="importBtnText">データをインポート</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 削除確認モーダル -->
    <div id="confirmModal" class="confirm-modal">
        <div class="confirm-content">
            <div class="confirm-icon">⚠️</div>
            <div class="confirm-title" id="confirmTitle">削除の確認</div>
            <div class="confirm-message" id="confirmMessage">この操作は元に戻せません。</div>
            <div class="confirm-buttons">
                <button class="btn" onclick="closeConfirmModal()" style="background: #6c757d; color: white;">キャンセル</button>
                <button class="btn" onclick="executeDelete()" style="background: #dc2626; color: white;">完全削除</button>
            </div>
        </div>
    </div>

    <!-- 取引詳細モーダル -->
    <div id="transactionDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>当月の発注詳細</h2>
                <button onclick="closeTransactionDetailModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">✕</button>
            </div>
            <div class="modal-body">
                <div id="transactionDetailContent" class="transaction-details">
                    <!-- 動的に生成される -->
                </div>
            </div>
        </div>
    </div>

    <!-- OCRモーダル -->
    <div id="ocrModal" class="ocr-modal">
        <div class="ocr-modal-content">
            <div class="modal-header">
                <h2>📸 使用記録の読み取り</h2>
                <button onclick="closeOCRModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">✕</button>
            </div>
            <div class="modal-body">
                <div class="ocr-options">
                    <button onclick="selectImageFile()" class="btn btn-primary">
                        📁 画像ファイルを選択
                    </button>
                    <button onclick="printOCRTemplate()" class="btn btn-secondary">
                        🖨️ 記録用紙を印刷
                    </button>
                </div>
                
                <input type="file" id="ocrFileInput" accept="image/*" style="display: none;" onchange="handleOCRFile(event)">
                
                <div id="ocrPreview" class="ocr-preview" style="display: none;"></div>
                
                <div id="ocrLoading" class="ocr-loading" style="display: none;">
                    <div class="ocr-loading-spinner"></div>
                    <p style="margin-top: 20px;">画像を解析中...</p>
                </div>
                
                <div id="ocrResults" class="ocr-results" style="display: none;">
                    <h3>認識結果の確認</h3>
                    <div class="ocr-staff-select">
                        <label>担当スタッフ: </label>
                        <select id="ocrStaffSelect">
                            <option value="">選択してください</option>
                        </select>
                    </div>
                    <table class="ocr-confirm-table" id="ocrConfirmTable">
                        <thead>
                            <tr>
                                <th>商品名</th>
                                <th>数量</th>
                                <th>単位</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="ocrTableBody">
                        </tbody>
                    </table>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn" onclick="addOCRRow()" style="background: #6c757d; color: white; margin-right: 10px;">
                            ➕ 商品追加
                        </button>
                        <button class="btn btn-primary" onclick="confirmOCRRecords()">
                            ✅ 確定して記録
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- OCR印刷用テンプレート -->
    <div id="ocrPrintTemplate" style="display: none;">
        <div class="ocr-template">
            <h2>在庫使用記録シート</h2>
            <p>日付: ________________</p>
            <p>担当: ________________</p>
            <hr style="margin: 20px 0;">
            
            <div class="ocr-items">
                <div class="ocr-item">
                    <span class="checkbox">□</span>
                    カラー剤6番 _______ 本
                </div>
                <div class="ocr-item">
                    <span class="checkbox">□</span>
                    カラー剤8番 _______ 本
                </div>
                <div class="ocr-item">
                    <span class="checkbox">□</span>
                    ミルボン シャンプー _______ 本
                </div>
                <div class="ocr-item">
                    <span class="checkbox">□</span>
                    トリートメント _______ 本
                </div>
                <div class="ocr-item">
                    <span class="checkbox">□</span>
                    ウエラ パーマ液 _______ 本
                </div>
                <div class="ocr-item">
                    <span class="checkbox">□</span>
                    N. オイル _______ 本
                </div>
                <div class="ocr-item">
                    <span class="checkbox">□</span>
                    その他: _____________ _______ 本
                </div>
            </div>
            
            <hr style="margin: 20px 0;">
            <p>備考: _________________________________</p>
        </div>
    </div>

    <!-- 同期ステータス -->
    <div id="syncStatus" class="sync-status">
        <span id="syncMessage">同期中...</span>
    </div>

    <script>
        // グローバル変数
        let currentUser = null;
        let users = {
            admin: { password: 'password', displayName: '管理者', email: '', shopName: '美容室サンプル' }
        };
        let db = null;
        let isCloudMode = false;
        let syncInProgress = false;
        
        // データ配列
        let products = [
            { id: 1, name: 'ロレアル カラー剤 6番', category: 'カラー剤', currentStock: 15, optimalStock: 20, unitPrice: 1200, supplier: 'ロレアル' },
            { id: 2, name: 'ミルボン シャンプー', category: 'シャンプー', currentStock: 8, optimalStock: 12, unitPrice: 2800, supplier: 'ミルボン' },
            { id: 3, name: 'ウエラ パーマ液', category: 'パーマ液', currentStock: 5, optimalStock: 10, unitPrice: 1800, supplier: 'ウエラ' },
            { id: 4, name: 'N. オイル', category: 'スタイリング', currentStock: 25, optimalStock: 15, unitPrice: 3400, supplier: 'ナプラ' }
        ];
        let staff = [
            { id: 1, name: '田中美香', role: '店長', staffCode: 'ST001', joinDate: '2020-04-01' },
            { id: 2, name: '佐藤花子', role: 'スタイリスト', staffCode: 'ST002', joinDate: '2021-06-15' },
            { id: 3, name: '山田太郎', role: 'アシスタント', staffCode: 'ST003', joinDate: '2023-03-01' }
        ];
        let transactions = [
            { id: 1, productId: 1, type: 'order', quantity: 10, date: '2025-08-01', time: '10:30', staffName: '田中美香', memo: '定期発注' },
            { id: 2, productId: 1, type: 'receipt', quantity: 10, date: '2025-08-01', time: '14:15', staffName: '佐藤花子', memo: '発注分入荷' },
            { id: 3, productId: 2, type: 'order', quantity: 5, date: '2025-08-01', time: '16:20', staffName: '山田太郎', memo: 'シャンプー発注' },
            { id: 4, productId: 4, type: 'receipt', quantity: 3, date: '2025-08-01', time: '11:45', staffName: '佐藤花子', memo: 'オイル入荷' },
            { id: 5, productId: 3, type: 'order', quantity: 8, date: '2025-08-01', time: '09:00', staffName: '田中美香', memo: 'パーマ液発注' }
        ];

        let editingProductId = null;
        let editingTransactionId = null;
        let currentCsvType = 'products';
        let csvData = [];
        let validationErrors = [];
        let pendingDeleteAction = null;
        let ocrRecords = []; // OCR認識結果の一時保存

        // Firebase 設定
        function setupFirebase() {
            const configText = document.getElementById('firebaseConfig').value.trim();
            
            if (!configText) {
                alert('Firebase設定を入力してください。');
                return;
            }
            
            try {
                // 設定文字列を解析
                let config;
                if (configText.startsWith('{')) {
                    config = eval('(' + configText + ')');
                } else {
                    config = JSON.parse(configText);
                }
                
                // Firebase初期化
                firebase.initializeApp(config);
                db = firebase.firestore();
                isCloudMode = true;
                
                // 設定を保存
                localStorage.setItem('firebaseConfig', JSON.stringify(config));
                
                // セットアップ完了
                document.getElementById('firebaseSetup').style.display = 'none';
                document.getElementById('loginContainer').style.display = 'flex';
                
                updateCloudStatus('接続済み', true);
                showSyncMessage('✅ Firebase接続完了！');
                
            } catch (error) {
                alert('Firebase設定にエラーがあります: ' + error.message);
                console.error('Firebase setup error:', error);
            }
        }

        // ローカルストレージモードで使用
        function useLocalStorage() {
            isCloudMode = false;
            document.getElementById('firebaseSetup').style.display = 'none';
            document.getElementById('loginContainer').style.display = 'flex';
            updateCloudStatus('ローカル', false);
        }

        // ログイン
        function login(event) {
            if (event) event.preventDefault();
            
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            
            if (users[username] && users[username].password === password) {
                currentUser = username;
                document.getElementById('currentUserName').textContent = `👤 ${users[username].displayName}`;
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                
                // 設定タブのユーザー情報を更新
                document.getElementById('settingsUsername').textContent = username;
                document.getElementById('settingsDisplayName').textContent = users[username].displayName;
                
                initializeApp();
                
                if (isCloudMode) {
                    loadCloudData();
                }
                
                showSyncMessage('✅ ログイン成功！');
                return true;
            } else {
                alert('ユーザー名またはパスワードが間違っています。');
                return false;
            }
        }

        // ログアウト
        function logout() {
            currentUser = null;
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('loginContainer').style.display = 'flex';
        }

        // パスワード変更モーダル表示
        function showPasswordModal() {
            document.getElementById('passwordModal').classList.add('show');
            // フォームをリセット
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            document.getElementById('passwordError').style.display = 'none';
            document.getElementById('passwordSuccess').style.display = 'none';
        }

        // パスワード変更モーダルを閉じる
        function closePasswordModal() {
            document.getElementById('passwordModal').classList.remove('show');
        }

        // パスワード変更処理
        function changePassword(event) {
            event.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorEl = document.getElementById('passwordError');
            const successEl = document.getElementById('passwordSuccess');
            
            // エラーメッセージをリセット
            errorEl.style.display = 'none';
            successEl.style.display = 'none';
            
            // 現在のパスワードチェック
            if (users[currentUser].password !== currentPassword) {
                errorEl.textContent = '現在のパスワードが正しくありません。';
                errorEl.style.display = 'block';
                return false;
            }
            
            // 新しいパスワードの確認
            if (newPassword !== confirmPassword) {
                errorEl.textContent = '新しいパスワードが一致しません。';
                errorEl.style.display = 'block';
                return false;
            }
            
            // パスワードの長さチェック
            if (newPassword.length < 6) {
                errorEl.textContent = 'パスワードは6文字以上で設定してください。';
                errorEl.style.display = 'block';
                return false;
            }
            
            // パスワード変更処理
            users[currentUser].password = newPassword;
            
            // ローカルストレージに保存
            localStorage.setItem('beautyInventoryUsers', JSON.stringify(users));
            
            // クラウドにも保存
            if (isCloudMode) {
                saveToCloud();
            }
            
            // 成功メッセージ表示
            successEl.textContent = 'パスワードが正常に変更されました。';
            successEl.style.display = 'block';
            
            // 1.5秒後にモーダルを閉じる
            setTimeout(() => {
                closePasswordModal();
                showSyncMessage('🔐 パスワードを変更しました');
            }, 1500);
            
            return false;
        }

        // アプリ初期化
        function initializeApp() {
            // 保存されたユーザー情報を読み込む
            const savedUsers = localStorage.getItem('beautyInventoryUsers');
            if (savedUsers) {
                users = JSON.parse(savedUsers);
            }
            
            renderProductsTable();
            renderStaffTable();
            renderTransactionsTable();
            updateProductSelect();
            updateStaffSelect();
            updateDashboardStats();
            updateMonthlyReport();
            updateDataStats();
        }

        // クラウドにデータ保存
        async function saveToCloud() {
            if (!isCloudMode || !db) {
                // ローカルモード時は従来の保存
                saveAllData();
                return;
            }
            
            if (syncInProgress) {
                showSyncMessage('⏳ 同期処理中です...');
                return;
            }
            
            syncInProgress = true;
            updateCloudStatus('同期中...', true);
            
            try {
                const batch = db.batch();
                
                // 商品データ保存
                products.forEach(product => {
                    const docRef = db.collection('products').doc(product.id.toString());
                    batch.set(docRef, product);
                });
                
                // スタッフデータ保存
                staff.forEach(member => {
                    const docRef = db.collection('staff').doc(member.id.toString());
                    batch.set(docRef, member);
                });
                
                // 取引データ保存
                transactions.forEach(transaction => {
                    const docRef = db.collection('transactions').doc(transaction.id.toString());
                    batch.set(docRef, transaction);
                });
                
                // ユーザー情報も保存
                const usersRef = db.collection('settings').doc('users');
                batch.set(usersRef, { users: users });
                
                // バッチ実行
                await batch.commit();
                
                // メタデータ保存
                await db.collection('metadata').doc('lastSync').set({
                    timestamp: new Date(),
                    user: currentUser,
                    dataCount: {
                        products: products.length,
                        staff: staff.length,
                        transactions: transactions.length
                    }
                });
                
                updateCloudStatus('同期完了', true);
                showSyncMessage('☁️ クラウド保存完了！');
                updateSyncStats();
                
            } catch (error) {
                console.error('Cloud save error:', error);
                updateCloudStatus('エラー', false);
                showSyncMessage('❌ 保存エラー: ' + error.message);
            } finally {
                syncInProgress = false;
            }
        }

        // データ保存機能（ローカル版互換）
        function saveAllData() {
            try {
                const dataToSave = {
                    products: products,
                    staff: staff,
                    transactions: transactions,
                    users: users,
                    savedAt: new Date().toISOString(),
                    version: '1.0'
                };
                
                localStorage.setItem('beautyInventoryData', JSON.stringify(dataToSave));
                localStorage.setItem('beautyInventoryUsers', JSON.stringify(users));
                
                showSyncMessage('💾 ローカル保存完了！');
                updateDataStats();
                
            } catch (error) {
                alert('❌ 保存中にエラーが発生しました。\n\n' + error.message);
                console.error('保存エラー:', error);
            }
        }

        // クラウドからデータ読み込み
        async function loadCloudData() {
            if (!isCloudMode || !db) {
                // ローカルモード時は従来の読み込み
                loadAllData();
                return;
            }
            
            if (syncInProgress) return;
            
            syncInProgress = true;
            updateCloudStatus('読み込み中...', true);
            
            try {
                // 商品データ読み込み
                const productsSnapshot = await db.collection('products').get();
                if (!productsSnapshot.empty) {
                    products = [];
                    productsSnapshot.forEach(doc => {
                        products.push(doc.data());
                    });
                }
                
                // スタッフデータ読み込み
                const staffSnapshot = await db.collection('staff').get();
                if (!staffSnapshot.empty) {
                    staff = [];
                    staffSnapshot.forEach(doc => {
                        staff.push(doc.data());
                    });
                }
                
                // 取引データ読み込み
                const transactionsSnapshot = await db.collection('transactions').get();
                if (!transactionsSnapshot.empty) {
                    transactions = [];
                    transactionsSnapshot.forEach(doc => {
                        transactions.push(doc.data());
                    });
                }
                
                // ユーザー情報読み込み
                const usersDoc = await db.collection('settings').doc('users').get();
                if (usersDoc.exists) {
                    const data = usersDoc.data();
                    if (data.users) {
                        users = data.users;
                    }
                }
                
                // UI更新
                renderProductsTable();
                renderStaffTable();
                renderTransactionsTable();
                updateProductSelect();
                updateStaffSelect();
                updateDashboardStats();
                updateMonthlyReport();
                
                updateCloudStatus('同期完了', true);
                showSyncMessage('📥 クラウドデータ読み込み完了！');
                updateSyncStats();
                
            } catch (error) {
                console.error('Cloud load error:', error);
                updateCloudStatus('エラー', false);
                showSyncMessage('❌ 読み込みエラー: ' + error.message);
            } finally {
                syncInProgress = false;
            }
        }

        // データ読み込み機能（ローカル版互換）
        function loadAllData() {
            try {
                const savedData = localStorage.getItem('beautyInventoryData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    
                    if (data.products) products = data.products;
                    if (data.staff) staff = data.staff;
                    if (data.transactions) transactions = data.transactions;
                    if (data.users) users = data.users;
                    
                    console.log('保存データを復元しました:', data.savedAt);
                    return true;
                } else {
                    console.log('保存データが見つかりません。初回起動です。');
                    return false;
                }
            } catch (error) {
                console.error('データ読み込みエラー:', error);
                return false;
            }
        }

        // 強制同期
        async function forceSync() {
            await saveToCloud();
            setTimeout(() => loadCloudData(), 1000);
        }

        // クラウドデータ削除
        async function clearCloudData() {
            if (!isCloudMode || !db) return;
            
            if (confirm('⚠️ 警告: クラウドの全データを削除しますか？\n\nこの操作は元に戻せません！')) {
                try {
                    const batch = db.batch();
                    
                    const collections = ['products', 'staff', 'transactions', 'metadata'];
                    
                    for (const collectionName of collections) {
                        const snapshot = await db.collection(collectionName).get();
                        snapshot.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                    }
                    
                    await batch.commit();
                    showSyncMessage('🗑️ クラウドデータを削除しました');
                    
                } catch (error) {
                    alert('削除エラー: ' + error.message);
                }
            }
        }

        // UI 更新関数
        function updateCloudStatus(message, isOnline) {
            const statusElement = document.getElementById('cloudStatus');
            const indicatorElement = document.getElementById('cloudIndicator');
            
            if (statusElement) statusElement.textContent = message;
            if (indicatorElement) {
                indicatorElement.className = isOnline ? 'cloud-indicator' : 'cloud-indicator offline';
            }
        }

        function showSyncMessage(message) {
            const syncStatus = document.getElementById('syncStatus');
            const syncMessage = document.getElementById('syncMessage');
            
            if (syncMessage) syncMessage.textContent = message;
            if (syncStatus) {
                syncStatus.classList.add('show');
                setTimeout(() => {
                    syncStatus.classList.remove('show');
                }, 3000);
            }
        }

        function updateSyncStats() {
            const lastSyncElement = document.getElementById('lastSync');
            const projectIdElement = document.getElementById('projectId');
            const syncStateElement = document.getElementById('syncState');
            
            if (lastSyncElement) {
                lastSyncElement.textContent = new Date().toLocaleString('ja-JP');
            }
            
            if (projectIdElement && isCloudMode) {
                const config = JSON.parse(localStorage.getItem('firebaseConfig') || '{}');
                projectIdElement.textContent = config.projectId || '未設定';
            }
            
            if (syncStateElement) {
                syncStateElement.textContent = isCloudMode ? '🟢 クラウド同期' : '🔵 ローカル';
            }
        }

        function updateDataStats() {
            const statsProducts = document.getElementById('stats-products');
            const statsStaff = document.getElementById('stats-staff');
            const statsTransactions = document.getElementById('stats-transactions');
            const statsLastSave = document.getElementById('stats-last-save');
            
            if (statsProducts) statsProducts.textContent = products.length;
            if (statsStaff) statsStaff.textContent = staff.length;
            if (statsTransactions) statsTransactions.textContent = transactions.length;
            
            if (statsLastSave) {
                try {
                    const savedData = localStorage.getItem('beautyInventoryData');
                    if (savedData) {
                        const data = JSON.parse(savedData);
                        const lastSave = new Date(data.savedAt).toLocaleString('ja-JP');
                        statsLastSave.textContent = lastSave;
                    } else {
                        statsLastSave.textContent = '未保存';
                    }
                } catch (error) {
                    statsLastSave.textContent = 'エラー';
                }
            }
        }

        // タブ切り替え
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'dashboard') {
                updateDashboardStats();
            } else if (tabName === 'reports') {
                updateMonthlyReport();
            } else if (tabName === 'settings') {
                updateDataStats();
                updateSyncStats();
            }
        }

        // ダッシュボードの統計情報を更新
        function updateDashboardStats() {
            const totalProducts = products.length;
            let criticalCount = 0;
            let warningCount = 0;
            let optimalCount = 0;
            let totalInventoryValue = 0;

            products.forEach(product => {
                const stockDiff = product.currentStock - product.optimalStock;
                const inventoryValue = product.currentStock * product.unitPrice;
                totalInventoryValue += inventoryValue;

                if (stockDiff <= -5) {
                    criticalCount++;
                } else if (stockDiff < 0) {
                    warningCount++;
                } else {
                    optimalCount++;
                }
            });

            // 統計カードを更新
            const totalProductsEl = document.getElementById('dashboard-total-products');
            const warningStockEl = document.getElementById('dashboard-warning-stock');
            const optimalStockEl = document.getElementById('dashboard-optimal-stock');
            const inventoryValueEl = document.getElementById('dashboard-inventory-value');

            if (totalProductsEl) totalProductsEl.textContent = totalProducts;
            if (warningStockEl) warningStockEl.textContent = criticalCount + warningCount;
            if (optimalStockEl) optimalStockEl.textContent = optimalCount;
            if (inventoryValueEl) inventoryValueEl.textContent = `¥${Math.round(totalInventoryValue / 1000)}K`;

            // アラートを更新
            const alertElement = document.getElementById('stock-alert');
            const alertDetails = document.getElementById('alert-details');
            
            if (alertElement && alertDetails) {
                if (criticalCount > 0 || warningCount > 0) {
                    alertDetails.textContent = `緊急: ${criticalCount}品目, 要注意: ${warningCount}品目の商品で在庫が不足しています。早急な発注をご検討ください。`;
                    alertElement.style.display = 'block';
                } else {
                    alertElement.style.display = 'none';
                }
            }

            updateDashboardStockTable();
        }

        // ダッシュボードの在庫状況テーブルを更新
        function updateDashboardStockTable() {
            const tbody = document.getElementById('dashboard-stock-table');
            if (!tbody) return;
            
            tbody.innerHTML = '';

            products.forEach(product => {
                const stockDiff = product.currentStock - product.optimalStock;
                const inventoryValue = product.currentStock * product.unitPrice;
                
                let statusClass, statusText;
                if (stockDiff <= -5) {
                    statusClass = 'status-critical';
                    statusText = '緊急';
                } else if (stockDiff < 0) {
                    statusClass = 'status-low';
                    statusText = '要注意';
                } else if (stockDiff > 5) {
                    statusClass = 'status-excess';
                    statusText = '過剰';
                } else {
                    statusClass = 'status-optimal';
                    statusText = '適正';
                }

                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>
                        <strong>${product.name}</strong><br>
                        <small>${product.category}</small>
                    </td>
                    <td>${product.currentStock} 本</td>
                    <td>${product.optimalStock} 本</td>
                    <td style="color: ${stockDiff < 0 ? '#dc2626' : '#059669'};">${stockDiff >= 0 ? '+' : ''}${stockDiff}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td>¥${inventoryValue.toLocaleString()}</td>
                `;
            });
        }

        // 商品管理関連の関数（元の機能をすべて含む）
        function showAddProductForm() {
            const form = document.getElementById('addProductForm');
            if (form) form.classList.remove('hidden');
        }

        function hideAddProductForm() {
            const form = document.getElementById('addProductForm');
            if (form) form.classList.add('hidden');
            clearProductForm();
        }

        function clearProductForm() {
            const elements = ['productName', 'optimalStock', 'unitPrice', 'supplier'];
            elements.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            
            const category = document.getElementById('category');
            if (category) category.value = 'カラー剤';
        }

        function addProduct() {
            const name = document.getElementById('productName').value;
            const optimalStock = document.getElementById('optimalStock').value;
            const unitPrice = document.getElementById('unitPrice').value;
            const supplier = document.getElementById('supplier').value;
            const category = document.getElementById('category').value;

            if (!name || !optimalStock || !supplier) {
                alert('商品名・適正在庫数・仕入先は必須です。');
                return;
            }

            const maxId = products.length > 0 ? Math.max(...products.map(p => p.id)) : 0;
            const newProduct = {
                id: maxId + 1,
                name,
                category,
                currentStock: 0,
                optimalStock: parseInt(optimalStock),
                unitPrice: parseInt(unitPrice) || 0,
                supplier
            };

            products.push(newProduct);
            renderProductsTable();
            updateProductSelect();
            updateDashboardStats();
            updateMonthlyReport();
            hideAddProductForm();
            
            // 自動保存
            if (isCloudMode) {
                saveToCloud();
            } else {
                saveAllData();
            }
            
            alert('商品を追加しました！');
        }

        function renderProductsTable() {
            const tbody = document.getElementById('productsTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';

            products.forEach(product => {
                const row = tbody.insertRow();
                row.setAttribute('data-product-id', product.id);

                if (editingProductId === product.id) {
                    // 編集モード
                    row.innerHTML = `
                        <td><input type="text" class="form-control edit-name" value="${product.name}" style="width: 100%;"></td>
                        <td>${product.category}</td>
                        <td><input type="number" class="form-control edit-current-stock" value="${product.currentStock}" style="width: 80px;"> 本</td>
                        <td><input type="number" class="form-control edit-optimal-stock" value="${product.optimalStock}" style="width: 80px;"> 本</td>
                        <td><input type="number" class="form-control edit-unit-price" value="${product.unitPrice}" style="width: 100px;" placeholder="0"></td>
                        <td><input type="text" class="form-control edit-supplier" value="${product.supplier}" style="width: 100%;"></td>
                        <td>
                            <button class="btn" onclick="saveProductEdit(${product.id})" style="background: #10b981; color: white; padding: 6px 12px; font-size: 0.8rem; margin-right: 5px;">保存</button>
                            <button class="btn" onclick="cancelProductEdit()" style="background: #6c757d; color: white; padding: 6px 12px; font-size: 0.8rem;">取消</button>
                        </td>
                    `;
                } else {
                    // 表示モード
                    row.innerHTML = `
                        <td>${product.name}</td>
                        <td>${product.category}</td>
                        <td>${product.currentStock} 本</td>
                        <td>${product.optimalStock} 本</td>
                        <td>¥${product.unitPrice.toLocaleString()}</td>
                        <td>${product.supplier}</td>
                        <td>
                            <button class="btn" onclick="editProduct(${product.id})" style="background: #3b82f6; color: white; padding: 6px 12px; font-size: 0.8rem; margin-right: 5px;">編集</button>
                            <button class="btn" onclick="deleteProduct(${product.id})" style="background: #dc2626; color: white; padding: 6px 12px; font-size: 0.8rem;">削除</button>
                        </td>
                    `;
                }
            });
        }

        function editProduct(productId) {
            editingProductId = productId;
            renderProductsTable();
        }

        function saveProductEdit(productId) {
            const row = document.querySelector(`tr[data-product-id="${productId}"]`);
            const name = row.querySelector('.edit-name').value;
            const currentStock = parseInt(row.querySelector('.edit-current-stock').value);
            const optimalStock = parseInt(row.querySelector('.edit-optimal-stock').value);
            const unitPrice = parseInt(row.querySelector('.edit-unit-price').value) || 0;
            const supplier = row.querySelector('.edit-supplier').value;

            if (!name || !supplier) {
                alert('商品名と仕入先は必須です。');
                return;
            }

            const productIndex = products.findIndex(p => p.id === productId);
            if (productIndex !== -1) {
                products[productIndex] = {
                    ...products[productIndex],
                    name,
                    currentStock,
                    optimalStock,
                    unitPrice,
                    supplier
                };
            }

            editingProductId = null;
            renderProductsTable();
            updateProductSelect();
            updateDashboardStats();
            updateMonthlyReport();
            
            // 自動保存
            if (isCloudMode) {
                saveToCloud();
            } else {
                saveAllData();
            }
            
            alert('商品情報を更新しました！');
        }

        function cancelProductEdit() {
            editingProductId = null;
            renderProductsTable();
        }

        function deleteProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            if (confirm(`「${product.name}」を削除しますか？\n関連する取引記録も削除されます。`)) {
                // 関連する取引記録を削除
                transactions = transactions.filter(t => t.productId !== productId);
                
                // 商品を削除
                products = products.filter(p => p.id !== productId);
                
                renderProductsTable();
                renderTransactionsTable();
                updateProductSelect();
                updateDashboardStats();
                updateMonthlyReport();
                
                // 自動保存
                if (isCloudMode) {
                    saveToCloud();
                } else {
                    saveAllData();
                }
                
                alert('商品を削除しました。');
            }
        }

        // スタッフ管理関連
        function renderStaffTable() {
            const tbody = document.getElementById('staffTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';

            staff.forEach(member => {
                const row = tbody.insertRow();
                const roleStyles = {
                    '店長': 'background: #a855f7; color: white;',
                    'スタイリスト': 'background: #3b82f6; color: white;',
                    'アシスタント': 'background: #10b981; color: white;',
                    'スタッフ': 'background: #10b981; color: white;'
                };

                row.innerHTML = `
                    <td>${member.staffCode}</td>
                    <td>${member.name}</td>
                    <td><span class="status-badge" style="${roleStyles[member.role]}">${member.role}</span></td>
                    <td><span class="status-badge status-optimal">在籍</span></td>
                    <td>${member.joinDate || new Date().toISOString().split('T')[0]}</td>
                    <td>
                        <button class="btn" onclick="deleteStaff(${member.id})" style="background: #dc2626; color: white; padding: 6px 12px; font-size: 0.8rem;">削除</button>
                    </td>
                `;
            });
        }

        function deleteStaff(staffId) {
            const member = staff.find(s => s.id === staffId);
            if (!member) return;
            
            if (confirm(`「${member.name}」を削除しますか？`)) {
                staff = staff.filter(s => s.id !== staffId);
                renderStaffTable();
                updateStaffSelect();
                
                // 自動保存
                if (isCloudMode) {
                    saveToCloud();
                } else {
                    saveAllData();
                }
                
                alert('スタッフを削除しました。');
            }
        }

        // 取引記録関連
        function showAddTransactionForm() {
            const form = document.getElementById('addTransactionForm');
            if (form) form.classList.remove('hidden');
        }

        function hideAddTransactionForm() {
            const form = document.getElementById('addTransactionForm');
            if (form) form.classList.add('hidden');
            clearTransactionForm();
        }

        function clearTransactionForm() {
            const elements = ['transactionProduct', 'transactionQuantity', 'transactionStaff', 'transactionMemo'];
            elements.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            
            const type = document.getElementById('transactionType');
            if (type) type.value = 'order';
        }

        function addTransaction() {
            const productIdValue = document.getElementById('transactionProduct').value;
            const type = document.getElementById('transactionType').value;
            const quantity = parseInt(document.getElementById('transactionQuantity').value);
            const staffName = document.getElementById('transactionStaff').value;
            const memo = document.getElementById('transactionMemo').value;

            if (!productIdValue || !quantity || !staffName) {
                alert('商品・数量・担当者は必須です。');
                return;
            }

            const productId = parseInt(productIdValue);
            const now = new Date();
            const date = now.toISOString().split('T')[0];
            const time = now.toTimeString().slice(0, 5);

            const newTransaction = {
                id: Date.now(),
                productId: productId,
                type: type,
                quantity: quantity,
                date: date,
                time: time,
                staffName: staffName,
                memo: memo
            };

            transactions.unshift(newTransaction);

            // 在庫数を更新
            const selectedProduct = products.find(p => parseInt(p.id) === productId);
            if (selectedProduct) {
                if (type === 'receipt') {
                    selectedProduct.currentStock += quantity;
                } else if (type === 'use' || type === 'sale') {
                    selectedProduct.currentStock = Math.max(0, selectedProduct.currentStock - quantity);
                }
                renderProductsTable();
                updateDashboardStats();
            }

            hideAddTransactionForm();
            renderTransactionsTable();
            updateMonthlyReport();
            
            // 自動保存
            if (isCloudMode) {
                saveToCloud();
            } else {
                saveAllData();
            }
            
            alert('取引を追加しました！');
        }

        function renderTransactionsTable() {
            const tbody = document.getElementById('transactionsTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';

            const typeStyles = {
                order: 'background: #3b82f6; color: white;',
                receipt: 'background: #10b981; color: white;',
                use: 'background: #f59e0b; color: white;',
                sale: 'background: #8b5cf6; color: white;'
            };

            const typeLabels = {
                order: '発注',
                receipt: '入荷',
                use: '使用',
                sale: '販売'
            };

            transactions.forEach(transaction => {
                const row = tbody.insertRow();
                row.setAttribute('data-transaction-id', transaction.id);

                if (editingTransactionId === transaction.id) {
                    // 編集モード（簡略版）
                    row.innerHTML = `
                        <td>${transaction.date}<br><small>${transaction.time}</small></td>
                        <td>編集中...</td>
                        <td>編集中...</td>
                        <td>編集中...</td>
                        <td>編集中...</td>
                        <td>編集中...</td>
                        <td>
                            <button class="btn" onclick="cancelTransactionEdit()" style="background: #6c757d; color: white; padding: 4px 8px; font-size: 0.7rem;">取消</button>
                        </td>
                    `;
                } else {
                    // 表示モード
                    const relatedProduct = products.find(p => parseInt(p.id) === parseInt(transaction.productId));
                    const productName = relatedProduct ? relatedProduct.name : `削除された商品 (ID: ${transaction.productId})`;

                    row.innerHTML = `
                        <td>${transaction.date}<br><small>${transaction.time}</small></td>
                        <td>${productName}</td>
                        <td><span class="status-badge" style="${typeStyles[transaction.type]}">${typeLabels[transaction.type]}</span></td>
                        <td>${transaction.quantity}</td>
                        <td>${transaction.staffName}</td>
                        <td>${transaction.memo}</td>
                        <td>
                            <button class="btn" onclick="editTransaction(${transaction.id})" style="background: #3b82f6; color: white; padding: 4px 8px; font-size: 0.7rem; margin-right: 3px;">修正</button>
                            <button class="btn" onclick="deleteTransaction(${transaction.id})" style="background: #dc2626; color: white; padding: 4px 8px; font-size: 0.7rem;">削除</button>
                        </td>
                    `;
                }
            });
        }

        function editTransaction(transactionId) {
            editingTransactionId = transactionId;
            renderTransactionsTable();
        }

        function cancelTransactionEdit() {
            editingTransactionId = null;
            renderTransactionsTable();
        }

        function deleteTransaction(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) return;

            const relatedProduct = products.find(p => parseInt(p.id) === parseInt(transaction.productId));
            const productName = relatedProduct ? relatedProduct.name : `削除された商品 (ID: ${transaction.productId})`;

            if (confirm(`この取引記録を削除しますか？\n\n商品: ${productName}\n種別: ${getTypeLabel(transaction.type)}\n数量: ${transaction.quantity}\n\n※在庫数も自動調整されます`)) {
                // 在庫を元に戻す
                if (relatedProduct) {
                    if (transaction.type === 'receipt') {
                        relatedProduct.currentStock = Math.max(0, relatedProduct.currentStock - transaction.quantity);
                    } else if (transaction.type === 'use' || transaction.type === 'sale') {
                        relatedProduct.currentStock += transaction.quantity;
                    }
                }

                transactions = transactions.filter(t => t.id !== transactionId);

                renderTransactionsTable();
                renderProductsTable();
                updateDashboardStats();
                updateMonthlyReport();
                
                // 自動保存
                if (isCloudMode) {
                    saveToCloud();
                } else {
                    saveAllData();
                }

                alert('取引記録を削除しました。');
            }
        }

        function getTypeLabel(type) {
            const typeLabels = {
                order: '発注',
                receipt: '入荷',
                use: '使用',
                sale: '販売'
            };
            return typeLabels[type] || type;
        }

        // 月次レポート関連
        function calculateMonthlyReport() {
            const currentMonth = new Date().toISOString().slice(0, 7);
            
            const monthlyTransactions = transactions.filter(t => 
                t.type === 'order' && 
                t.date.startsWith(currentMonth)
            );

            let totalAmount = 0;
            const supplierTotals = {};
            const supplierCounts = {};
            const supplierQuantities = {};
            const transactionDetails = [];

            monthlyTransactions.forEach(transaction => {
                const relatedProduct = products.find(p => parseInt(p.id) === parseInt(transaction.productId));
                if (relatedProduct && relatedProduct.unitPrice > 0 && relatedProduct.supplier) {
                    const amount = transaction.quantity * relatedProduct.unitPrice;
                    totalAmount += amount;

                    const supplier = relatedProduct.supplier;
                    if (!supplierTotals[supplier]) {
                        supplierTotals[supplier] = 0;
                        supplierCounts[supplier] = 0;
                        supplierQuantities[supplier] = 0;
                    }
                    supplierTotals[supplier] += amount;
                    supplierCounts[supplier]++;
                    supplierQuantities[supplier] += transaction.quantity;

                    transactionDetails.push({
                        date: transaction.date,
                        time: transaction.time,
                        productName: relatedProduct.name,
                        type: transaction.type,
                        quantity: transaction.quantity,
                        unitPrice: relatedProduct.unitPrice,
                        amount: amount,
                        staffName: transaction.staffName,
                        memo: transaction.memo
                    });
                }
            });

            return {
                totalAmount,
                supplierCount: Object.keys(supplierTotals).length,
                transactionCount: monthlyTransactions.length,
                supplierTotals,
                supplierCounts,
                supplierQuantities,
                transactionDetails
            };
        }

        function updateMonthlyReport() {
            const report = calculateMonthlyReport();

            const amountElement = document.getElementById('monthly-amount');
            const supplierElement = document.getElementById('supplier-count');
            const transactionElement = document.getElementById('transaction-count');
            const lastUpdateElement = document.getElementById('last-update');

            if (amountElement) amountElement.textContent = `¥${report.totalAmount.toLocaleString()}`;
            if (supplierElement) supplierElement.textContent = report.supplierCount;
            if (transactionElement) transactionElement.textContent = report.transactionCount;
            if (lastUpdateElement) {
                const now = new Date();
                lastUpdateElement.textContent = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
            }

            const tbody = document.getElementById('supplier-report-tbody');
            if (tbody) {
                tbody.innerHTML = '';
                
                const sortedSuppliers = Object.entries(report.supplierTotals)
                    .sort(([,a], [,b]) => b - a);

                sortedSuppliers.forEach(([supplier, amount]) => {
                    const percentage = report.totalAmount > 0 ? (amount / report.totalAmount * 100).toFixed(1) : 0;
                    const count = report.supplierCounts[supplier];
                    const quantity = report.supplierQuantities[supplier];
                    const avgPrice = quantity > 0 ? Math.round(amount / quantity) : 0;
                    
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>
                            <strong>${supplier}</strong><br>
                            <small style="color: #6c757d;">${quantity}個発注</small>
                        </td>
                        <td>¥${amount.toLocaleString()}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span>${percentage}%</span>
                                <div style="width: 50px; height: 6px; background: #e9ecef; border-radius: 3px;">
                                    <div style="width: ${percentage}%; height: 100%; background: #8b5cf6; border-radius: 3px;"></div>
                                </div>
                            </div>
                        </td>
                        <td>${count}回</td>
                        <td>¥${avgPrice.toLocaleString()}</td>
                    `;
                });

                if (sortedSuppliers.length === 0) {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td colspan="5" style="text-align: center; color: #6c757d; font-style: italic; padding: 40px;">
                            <div style="font-size: 3rem; margin-bottom: 15px;">📊</div>
                            <div style="font-size: 1.1rem; margin-bottom: 5px;">当月の発注データがありません</div>
                            <div style="font-size: 0.9rem;">発注取引を追加すると自動的に集計されます</div>
                        </td>
                    `;
                }
            }
        }

        function showTransactionDetails() {
            const report = calculateMonthlyReport();
            const modal = document.getElementById('transactionDetailModal');
            const content = document.getElementById('transactionDetailContent');

            if (!modal || !content) return;

            content.innerHTML = '';

            if (report.transactionDetails.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6c757d;">
                        <div style="font-size: 3rem; margin-bottom: 15px;">📊</div>
                        <div>当月の発注データがありません</div>
                    </div>
                `;
            } else {
                const sortedTransactions = report.transactionDetails.sort((a, b) => {
                    const dateTimeA = new Date(`${a.date} ${a.time}`);
                    const dateTimeB = new Date(`${b.date} ${b.time}`);
                    return dateTimeB - dateTimeA;
                });

                sortedTransactions.forEach(transaction => {
                    const item = document.createElement('div');
                    item.className = 'transaction-item';
                    item.innerHTML = `
                        <div>
                            <strong>${transaction.productName}</strong>
                            <div style="font-size: 0.8rem; color: #6c757d;">
                                ${transaction.date} ${transaction.time} | 発注 | ${transaction.staffName}
                            </div>
                            ${transaction.memo ? `<div style="font-size: 0.8rem; color: #6c757d;">${transaction.memo}</div>` : ''}
                        </div>
                        <div style="text-align: right;">
                            <div><strong>${transaction.quantity}個</strong></div>
                            <div style="color: #8b5cf6;">¥${transaction.amount.toLocaleString()}</div>
                        </div>
                    `;
                    content.appendChild(item);
                });
            }

            modal.classList.add('show');
        }

        function closeTransactionDetailModal() {
            const modal = document.getElementById('transactionDetailModal');
            if (modal) modal.classList.remove('show');
        }

        // 選択肢更新
        function updateProductSelect() {
            const select = document.getElementById('transactionProduct');
            if (!select) return;
            
            select.innerHTML = '<option value="">商品を選択</option>';
            
            products.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = product.name;
                select.appendChild(option);
            });
        }

        function updateStaffSelect() {
            const select = document.getElementById('transactionStaff');
            if (!select) return;
            
            select.innerHTML = '<option value="">担当者を選択</option>';
            
            staff.forEach(member => {
                const option = document.createElement('option');
                option.value = member.name;
                option.textContent = member.name;
                select.appendChild(option);
            });
        }

        // CSV関連機能
        function showCsvModal(type) {
            currentCsvType = type;
            setCsvType(type);
            const modal = document.getElementById('csvModal');
            if (modal) modal.classList.add('show');
        }

        function closeCsvModal() {
            const modal = document.getElementById('csvModal');
            if (modal) modal.classList.remove('show');
            clearCsvData();
        }

        function setCsvType(type) {
            currentCsvType = type;
            
            const productBtn = document.getElementById('productTypeBtn');
            const staffBtn = document.getElementById('staffTypeBtn');
            const templateInfo = document.getElementById('templateInfo');
            
            if (type === 'products') {
                if (productBtn) productBtn.className = 'btn btn-primary';
                if (staffBtn) {
                    staffBtn.className = 'btn';
                    staffBtn.style.background = '#6c757d';
                    staffBtn.style.color = 'white';
                }
                if (templateInfo) templateInfo.textContent = '商品マスタ必須項目: name(商品名), currentStock(現在庫), optimalStock(適正在庫), supplier(仕入れ先) ※unitPrice(単価)は空白可';
            } else {
                if (staffBtn) staffBtn.className = 'btn btn-primary';
                if (productBtn) {
                    productBtn.className = 'btn';
                    productBtn.style.background = '#6c757d';
                    productBtn.style.color = 'white';
                }
                if (templateInfo) templateInfo.textContent = 'スタッフマスタ必須項目: name(名前)';
            }
        }

        function downloadTemplate() {
            let csvContent = '';
            
            if (currentCsvType === 'products') {
                csvContent = 'name,category,currentStock,optimalStock,unitPrice,supplier\n';
                csvContent += 'サンプル商品,カラー剤,10,20,1200,サンプル仕入先\n';
                csvContent += 'ロレアル カラー剤 7番,カラー剤,5,15,1300,ロレアル\n';
            } else {
                csvContent = 'name,role,staffCode,joinDate\n';
                csvContent += 'サンプル太郎,スタッフ,ST1001,2025-01-01\n';
                csvContent += '鈴木花子,スタイリスト,ST1002,2024-06-15\n';
            }

            // BOM付きで文字化け対策
            const bom = '\uFEFF';
            const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${currentCsvType}_template.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file && file.type === 'text/csv') {
                parseCSV(file);
            } else {
                alert('CSVファイルを選択してください。');
            }
        }

        function parseCSV(file) {
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                dynamicTyping: true,
                encoding: 'UTF-8',
                complete: function(results) {
                    csvData = results.data;
                    validateAndPreview(csvData);
                },
                error: function(error) {
                    alert('CSVファイルの読み込みに失敗しました: ' + error.message);
                }
            });
        }

        function validateAndPreview(data) {
            validationErrors = [];
            const preview = [];

            if (currentCsvType === 'products') {
                validateProductData(data, preview);
            } else {
                validateStaffData(data, preview);
            }

            displayPreview(preview);
        }

        function validateProductData(data, preview) {
            const requiredFields = ['name', 'currentStock', 'optimalStock', 'supplier'];
            
            data.forEach((row, index) => {
                const errors = [];
                
                requiredFields.forEach(field => {
                    if (!row[field] && row[field] !== 0 && row[field] !== '') {
                        errors.push(`${field}は必須です`);
                    }
                });

                if (row.currentStock && (isNaN(row.currentStock) || row.currentStock < 0)) {
                    errors.push('現在庫は正の数値である必要があります');
                }
                if (row.optimalStock && (isNaN(row.optimalStock) || row.optimalStock < 0)) {
                    errors.push('適正在庫は正の数値である必要があります');
                }
                if (row.unitPrice && row.unitPrice !== '' && (isNaN(row.unitPrice) || row.unitPrice < 0)) {
                    errors.push('単価は正の数値である必要があります');
                }

                if (errors.length > 0) {
                    validationErrors.push({
                        row: index + 1,
                        errors: errors
                    });
                }

                preview.push({
                    ...row,
                    hasErrors: errors.length > 0
                });
            });
        }

        function validateStaffData(data, preview) {
            const requiredFields = ['name'];
            
            data.forEach((row, index) => {
                const errors = [];
                
                requiredFields.forEach(field => {
                    if (!row[field] || row[field] === '') {
                        errors.push(`${field}は必須です`);
                    }
                });

                if (errors.length > 0) {
                    validationErrors.push({
                        row: index + 1,
                        errors: errors
                    });
                }

                preview.push({
                    ...row,
                    hasErrors: errors.length > 0
                });
            });
        }

        function displayPreview(preview) {
            const previewDiv = document.getElementById('csvPreview');
            const errorDiv = document.getElementById('errorSummary');
            const errorDetails = document.getElementById('errorDetails');
            const previewHeader = document.getElementById('previewHeader');
            const previewBody = document.getElementById('previewBody');

            if (!previewDiv) return;

            // エラー表示
            if (validationErrors.length > 0 && errorDiv && errorDetails) {
                errorDiv.classList.remove('hidden');
                errorDetails.innerHTML = '';
                validationErrors.slice(0, 5).forEach(error => {
                    const errorItem = document.createElement('div');
                    errorItem.className = 'error-item';
                    errorItem.textContent = `行${error.row}: ${error.errors.join(', ')}`;
                    errorDetails.appendChild(errorItem);
                });
                
                if (validationErrors.length > 5) {
                    const moreErrors = document.createElement('div');
                    moreErrors.className = 'error-item';
                    moreErrors.textContent = `他${validationErrors.length - 5}件のエラー...`;
                    errorDetails.appendChild(moreErrors);
                }
            } else if (errorDiv) {
                errorDiv.classList.add('hidden');
            }

            // プレビューテーブル作成
            let headers = [];
            if (currentCsvType === 'products') {
                headers = ['状態', '商品名', '現在庫', '適正在庫', '単価', '仕入れ先'];
            } else {
                headers = ['状態', '名前'];
            }

            if (previewHeader) {
                previewHeader.innerHTML = '';
                const headerRow = previewHeader.insertRow();
                headers.forEach(header => {
                    const th = document.createElement('th');
                    th.textContent = header;
                    headerRow.appendChild(th);
                });
            }

            if (previewBody) {
                previewBody.innerHTML = '';
                preview.forEach(row => {
                    const tr = previewBody.insertRow();
                    if (row.hasErrors) {
                        tr.style.background = '#fef2f2';
                    }

                    const statusCell = tr.insertCell();
                    statusCell.innerHTML = row.hasErrors ? '❌' : '✅';

                    if (currentCsvType === 'products') {
                        tr.insertCell().textContent = row.name || '';
                        tr.insertCell().textContent = row.currentStock || '0';
                        tr.insertCell().textContent = row.optimalStock || '';
                        tr.insertCell().textContent = row.unitPrice ? `¥${parseInt(row.unitPrice).toLocaleString()}` : '¥0';
                        tr.insertCell().textContent = row.supplier || '';
                    } else {
                        tr.insertCell().textContent = row.name || '';
                    }
                });
            }

            // インポートボタンの状態更新
            const importBtn = document.getElementById('importBtn');
            const importBtnText = document.getElementById('importBtnText');
            if (importBtn && importBtnText) {
                if (validationErrors.length > 0) {
                    importBtn.disabled = true;
                    importBtn.style.background = '#9ca3af';
                    importBtn.style.cursor = 'not-allowed';
                    importBtnText.textContent = 'エラーを修正してください';
                } else {
                    importBtn.disabled = false;
                    importBtn.style.background = '';
                    importBtn.style.cursor = 'pointer';
                    importBtnText.textContent = `${preview.length}件をインポート`;
                }
            }

            previewDiv.classList.remove('hidden');
        }

        function clearCsvData() {
            csvData = [];
            validationErrors = [];
            const previewDiv = document.getElementById('csvPreview');
            const csvFile = document.getElementById('csvFile');
            
            if (previewDiv) previewDiv.classList.add('hidden');
            if (csvFile) csvFile.value = '';
        }

        function importCsvData() {
            if (validationErrors.length > 0) {
                alert('エラーがあるためインポートできません。');
                return;
            }

            let message = '';
            if (currentCsvType === 'products') {
                const maxId = products.length > 0 ? Math.max(...products.map(p => p.id)) : 0;
                
                csvData.forEach((row, index) => {
                    const newProduct = {
                        id: maxId + index + 1,
                        name: row.name,
                        category: row.category || 'その他',
                        currentStock: parseInt(row.currentStock) || 0,
                        optimalStock: parseInt(row.optimalStock) || 0,
                        unitPrice: parseInt(row.unitPrice) || 0,
                        supplier: row.supplier || ''
                    };
                    products.push(newProduct);
                });
                
                // IDで並び替え
                products.sort((a, b) => a.id - b.id);
                
                renderProductsTable();
                updateProductSelect();
                updateDashboardStats();
                updateMonthlyReport();
                message = `${csvData.length}件の商品を登録しました。`;
            } else {
                const maxId = staff.length > 0 ? Math.max(...staff.map(s => s.id)) : 0;
                
                csvData.forEach((row, index) => {
                    const newStaff = {
                        id: maxId + index + 1,
                        name: row.name,
                        role: row.role || 'スタッフ',
                        staffCode: row.staffCode || `ST${(1000 + staff.length + index + 1).toString()}`,
                        joinDate: row.joinDate || new Date().toISOString().split('T')[0]
                    };
                    staff.push(newStaff);
                });
                
                // IDで並び替え
                staff.sort((a, b) => a.id - b.id);
                
                renderStaffTable();
                updateStaffSelect();
                message = `${csvData.length}件のスタッフを登録しました。`;
            }

            // 自動保存
            if (isCloudMode) {
                saveToCloud();
            } else {
                saveAllData();
            }

            alert(message);
            closeCsvModal();
        }

        // データエクスポート機能
        function exportData() {
            try {
                const dataToExport = {
                    products: products,
                    staff: staff,
                    transactions: transactions,
                    exportedAt: new Date().toISOString(),
                    version: '1.0'
                };
                
                const jsonString = JSON.stringify(dataToExport, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `美容室データバックアップ_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                alert('📥 データをJSONファイルでエクスポートしました！');
            } catch (error) {
                alert('❌ エクスポート中にエラーが発生しました。\n\n' + error.message);
            }
        }

        // データインポート機能
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        if (confirm(`📂 以下のデータをインポートしますか？\n\n📦 商品: ${importedData.products?.length || 0}件\n👥 スタッフ: ${importedData.staff?.length || 0}件\n📋 取引: ${importedData.transactions?.length || 0}件\n\n⚠️ 現在のデータは上書きされます。`)) {
                            
                            if (importedData.products) products = importedData.products;
                            if (importedData.staff) staff = importedData.staff;
                            if (importedData.transactions) transactions = importedData.transactions;
                            
                            renderProductsTable();
                            renderStaffTable();
                            renderTransactionsTable();
                            updateProductSelect();
                            updateStaffSelect();
                            updateDashboardStats();
                            updateMonthlyReport();
                            updateDataStats();
                            
                            // 自動保存
                            if (isCloudMode) {
                                saveToCloud();
                            } else {
                                saveAllData();
                            }
                            
                            alert('✅ データのインポートが完了しました！');
                        }
                    } catch (error) {
                        alert('❌ インポート中にエラーが発生しました。\n\nファイル形式を確認してください。\n\nエラー: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // ドラッグ&ドロップ処理
        function setupDragAndDrop() {
            const uploadZone = document.getElementById('uploadZone');
            if (!uploadZone) return;
            
            uploadZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('dragover');
            });

            uploadZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
            });

            uploadZone.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type === 'text/csv') {
                    parseCSV(files[0]);
                } else {
                    alert('CSVファイルをドロップしてください。');
                }
            });
        }

        // 削除確認モーダル関連
        function showConfirmModal(title, message, deleteAction) {
            const modal = document.getElementById('confirmModal');
            const titleEl = document.getElementById('confirmTitle');
            const messageEl = document.getElementById('confirmMessage');
            
            if (titleEl) titleEl.textContent = title;
            if (messageEl) messageEl.innerHTML = message;
            pendingDeleteAction = deleteAction;
            if (modal) modal.classList.add('show');
        }

        function closeConfirmModal() {
            const modal = document.getElementById('confirmModal');
            if (modal) modal.classList.remove('show');
            pendingDeleteAction = null;
        }

        function executeDelete() {
            if (pendingDeleteAction) {
                pendingDeleteAction();
                closeConfirmModal();
            }
        }

        // 初期化
        window.onload = function() {
            // 保存済みのFirebase設定があるかチェック
            const savedConfig = localStorage.getItem('firebaseConfig');
            
            if (savedConfig) {
                try {
                    const config = JSON.parse(savedConfig);
                    firebase.initializeApp(config);
                    db = firebase.firestore();
                    isCloudMode = true;
                    
                    document.getElementById('firebaseSetup').style.display = 'none';
                    document.getElementById('loginContainer').style.display = 'flex';
                    updateCloudStatus('接続済み', true);
                    
                } catch (error) {
                    console.error('Firebase initialization error:', error);
                    document.getElementById('firebaseSetup').style.display = 'flex';
                }
            } else {
                document.getElementById('firebaseSetup').style.display = 'flex';
            }
            
            // ドラッグ&ドロップ設定
            setTimeout(setupDragAndDrop, 1000);
            
            updateSyncStats();
        };

        // OCR関連の関数
        function showOCRModal() {
            const modal = document.getElementById('ocrModal');
            if (modal) {
                modal.classList.add('show');
                // スタッフ選択を更新
                updateOCRStaffSelect();
            }
        }

        function closeOCRModal() {
            const modal = document.getElementById('ocrModal');
            if (modal) {
                modal.classList.remove('show');
                // リセット
                document.getElementById('ocrPreview').style.display = 'none';
                document.getElementById('ocrResults').style.display = 'none';
                document.getElementById('ocrLoading').style.display = 'none';
                ocrRecords = [];
            }
        }

        function selectImageFile() {
            document.getElementById('ocrFileInput').click();
        }

        function handleOCRFile(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                // プレビュー表示
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('ocrPreview');
                    preview.innerHTML = `<img src="${e.target.result}" alt="プレビュー">`;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
                
                // OCR処理開始
                processOCR(file);
            }
        }

        async function processOCR(imageFile) {
            // ローディング表示
            document.getElementById('ocrLoading').style.display = 'block';
            document.getElementById('ocrResults').style.display = 'none';
            
            try {
                // Tesseract.jsでOCR実行
                const result = await Tesseract.recognize(
                    imageFile,
                    'jpn',  // 日本語
                    {
                        logger: m => {
                            console.log(m);
                            // 進捗表示も可能
                            if (m.status === 'recognizing text') {
                                const percent = Math.round(m.progress * 100);
                                const loading = document.querySelector('#ocrLoading p');
                                if (loading) {
                                    loading.textContent = `画像を解析中... ${percent}%`;
                                }
                            }
                        }
                    }
                );
                
                console.log('OCR結果:', result.data.text);
                
                // テキストを解析
                const records = parseOCRText(result.data.text);
                
                // 結果表示
                showOCRResults(records);
                
            } catch (error) {
                alert('読み取りエラー: ' + error.message);
                console.error('OCR Error:', error);
            } finally {
                document.getElementById('ocrLoading').style.display = 'none';
            }
        }

        function parseOCRText(text) {
            const records = [];
            const lines = text.split('\n');
            
            // 各商品のパターンを定義
            const productPatterns = [
                { pattern: /カラー剤.*?6番.*?(\d+)/, name: 'ロレアル カラー剤 6番' },
                { pattern: /カラー剤.*?8番.*?(\d+)/, name: 'ロレアル カラー剤 8番' },
                { pattern: /ミルボン.*?シャンプー.*?(\d+)/, name: 'ミルボン シャンプー' },
                { pattern: /トリートメント.*?(\d+)/, name: 'トリートメント' },
                { pattern: /ウエラ.*?パーマ液.*?(\d+)/, name: 'ウエラ パーマ液' },
                { pattern: /N\.?\s*オイル.*?(\d+)/, name: 'N. オイル' }
            ];
            
            // 各行をチェック
            lines.forEach(line => {
                productPatterns.forEach(({ pattern, name }) => {
                    const match = line.match(pattern);
                    if (match && match[1]) {
                        const quantity = parseInt(match[1]);
                        if (quantity > 0) {
                            // 実際の商品IDを探す
                            const product = products.find(p => p.name === name);
                            if (product) {
                                records.push({
                                    productId: product.id,
                                    productName: product.name,
                                    quantity: quantity,
                                    recognized: true
                                });
                            }
                        }
                    }
                });
            });
            
            return records;
        }

        function showOCRResults(records) {
            ocrRecords = records;
            
            // スタッフ選択を更新
            updateOCRStaffSelect();
            
            // テーブルに結果を表示
            const tbody = document.getElementById('ocrTableBody');
            tbody.innerHTML = '';
            
            records.forEach((record, index) => {
                addOCRTableRow(record, index);
            });
            
            // 認識されなかった場合は空行を追加
            if (records.length === 0) {
                addOCRRow();
            }
            
            document.getElementById('ocrResults').style.display = 'block';
        }

        function addOCRTableRow(record, index) {
            const tbody = document.getElementById('ocrTableBody');
            const row = tbody.insertRow();
            
            row.innerHTML = `
                <td>
                    <select id="ocr-product-${index}" class="form-control" style="width: 200px;">
                        <option value="">商品を選択</option>
                        ${products.map(p => `
                            <option value="${p.id}" ${record && record.productId === p.id ? 'selected' : ''}>
                                ${p.name}
                            </option>
                        `).join('')}
                    </select>
                </td>
                <td>
                    <input type="number" id="ocr-qty-${index}" class="form-control" 
                           value="${record ? record.quantity : 1}" min="1" style="width: 80px;">
                </td>
                <td>本</td>
                <td>
                    <button class="btn" onclick="removeOCRRow(${index})" 
                            style="background: #dc2626; color: white; padding: 4px 8px; font-size: 0.8rem;">
                        削除
                    </button>
                </td>
            `;
        }

        function addOCRRow() {
            const newIndex = document.querySelectorAll('#ocrTableBody tr').length;
            addOCRTableRow(null, newIndex);
        }

        function removeOCRRow(index) {
            const tbody = document.getElementById('ocrTableBody');
            tbody.deleteRow(index);
            
            // インデックスを再調整
            const rows = tbody.querySelectorAll('tr');
            rows.forEach((row, newIndex) => {
                // ID属性を更新
                const select = row.querySelector('select');
                const input = row.querySelector('input[type="number"]');
                const button = row.querySelector('button');
                
                if (select) select.id = `ocr-product-${newIndex}`;
                if (input) input.id = `ocr-qty-${newIndex}`;
                if (button) button.setAttribute('onclick', `removeOCRRow(${newIndex})`);
            });
        }

        function updateOCRStaffSelect() {
            const select = document.getElementById('ocrStaffSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">選択してください</option>';
            staff.forEach(member => {
                const option = document.createElement('option');
                option.value = member.name;
                option.textContent = member.name;
                select.appendChild(option);
            });
        }

        function confirmOCRRecords() {
            const staffName = document.getElementById('ocrStaffSelect').value;
            if (!staffName) {
                alert('担当スタッフを選択してください。');
                return;
            }
            
            const records = [];
            const rows = document.querySelectorAll('#ocrTableBody tr');
            
            rows.forEach((row, index) => {
                const productId = document.getElementById(`ocr-product-${index}`).value;
                const quantity = parseInt(document.getElementById(`ocr-qty-${index}`).value);
                
                if (productId && quantity > 0) {
                    records.push({
                        productId: parseInt(productId),
                        quantity: quantity
                    });
                }
            });
            
            if (records.length === 0) {
                alert('記録する商品がありません。');
                return;
            }
            
            // 確認
            const confirmMessage = records.map(r => {
                const product = products.find(p => p.id === r.productId);
                return `${product.name}: ${r.quantity}本`;
            }).join('\n');
            
            if (confirm(`以下の内容で記録しますか？\n\n担当: ${staffName}\n\n${confirmMessage}`)) {
                // 取引記録として追加
                const now = new Date();
                const date = now.toISOString().split('T')[0];
                const time = now.toTimeString().slice(0, 5);
                
                records.forEach(record => {
                    const newTransaction = {
                        id: Date.now() + Math.random(), // ユニークID
                        productId: record.productId,
                        type: 'use',
                        quantity: record.quantity,
                        date: date,
                        time: time,
                        staffName: staffName,
                        memo: 'OCR読み取り'
                    };
                    
                    transactions.unshift(newTransaction);
                    
                    // 在庫を更新
                    const product = products.find(p => p.id === record.productId);
                    if (product) {
                        product.currentStock = Math.max(0, product.currentStock - record.quantity);
                    }
                });
                
                // UI更新
                renderTransactionsTable();
                renderProductsTable();
                updateDashboardStats();
                updateMonthlyReport();
                
                // 自動保存
                if (isCloudMode) {
                    saveToCloud();
                } else {
                    saveAllData();
                }
                
                alert('記録を保存しました！');
                closeOCRModal();
            }
        }

        function printOCRTemplate() {
            const printWindow = window.open('', '_blank');
            const template = document.getElementById('ocrPrintTemplate').innerHTML;
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>在庫使用記録シート</title>
                    <style>
                        @page { margin: 20mm; }
                        body { margin: 0; }
                        ${document.querySelector('style').textContent}
                    </style>
                </head>
                <body>
                    ${template}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.onload = function() {
                printWindow.print();
                printWindow.close();
            };
        }
    </script>
</body>
</html>