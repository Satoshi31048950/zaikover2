<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ç¾å®¹å®¤åœ¨åº«ç®¡ç†">
    <meta name="theme-color" content="#ec4899">
    <title>ç¾å®¹å®¤åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - ã‚¯ãƒ©ã‚¦ãƒ‰ç‰ˆ</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src='https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js'></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #fdf2f8 0%, #f3e8ff 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .cloud-status {
            position: absolute;
            top: 20px;
            left: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        .cloud-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }
        
        .cloud-indicator.offline {
            background: #dc2626;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .user-info {
            position: absolute;
            top: 20px;
            right: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-info span {
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        .save-btn {
            background: rgba(16, 185, 129, 0.9);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .save-btn:hover {
            background: rgba(16, 185, 129, 1);
            border-color: rgba(255,255,255,0.5);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
        }
        
        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        
        .nav-tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .nav-tab:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }
        
        .nav-tab.active {
            background: white;
            color: #ec4899;
            border-bottom: 3px solid #ec4899;
        }
        
        .content {
            padding: 30px;
            min-height: 600px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            padding: 25px;
            border-radius: 15px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card.pink {
            background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%);
        }
        
        .stat-card.blue {
            background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%);
        }
        
        .stat-card.green {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .stat-card.orange {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .stat-info h3 {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        
        .stat-info .number {
            font-size: 2.5rem;
            font-weight: bold;
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            opacity: 0.8;
        }
        
        .table-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-top: 20px;
        }
        
        .table-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-header h3 {
            color: #495057;
            font-size: 1.3rem;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-critical {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .status-low {
            background: #fef3c7;
            color: #d97706;
        }
        
        .status-optimal {
            background: #d1fae5;
            color: #059669;
        }
        
        .status-excess {
            background: #dbeafe;
            color: #2563eb;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(236, 72, 153, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.3);
        }
        
        .alert {
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #dc2626;
            background: #fef2f2;
            color: #7f1d1d;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            padding: 25px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 25px;
        }
        
        .upload-zone {
            border: 2px dashed #d1d5db;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-zone:hover {
            border-color: #8b5cf6;
            background: #f9fafb;
        }
        
        .upload-zone.dragover {
            border-color: #8b5cf6;
            background: #f3e8ff;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .form-control {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #8b5cf6;
        }
        
        .csv-preview {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .error-list {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .error-item {
            color: #dc2626;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .hidden {
            display: none;
        }
        
        .flex {
            display: flex;
        }
        
        .justify-between {
            justify-content: space-between;
        }
        
        .gap-10 {
            gap: 10px;
        }
        
        .text-right {
            text-align: right;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }

        /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
        .login-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #fdf2f8 0%, #f3e8ff 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .login-box {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-header h1 {
            background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .login-form input {
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .login-form input:focus {
            outline: none;
            border-color: #8b5cf6;
        }
        
        .login-btn {
            background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%);
            color: white;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(236, 72, 153, 0.3);
        }

        /* Firebaseè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« */
        .firebase-setup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .firebase-setup-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .setup-step {
            margin-bottom: 25px;
            padding: 20px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
        }
        
        .setup-step h3 {
            color: #ec4899;
            margin-bottom: 15px;
        }
        
        .config-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: monospace;
            font-size: 0.9rem;
            background: #f8f9fa;
        }

        /* å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« */
        .confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .confirm-modal.show {
            display: flex;
        }
        
        .confirm-content {
            background: white;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            padding: 30px;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        }
        
        .confirm-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }
        
        .confirm-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #dc2626;
        }
        
        .confirm-message {
            margin-bottom: 25px;
            color: #6c757d;
            line-height: 1.6;
        }
        
        .confirm-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        /* å–å¼•è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .transaction-details {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .transaction-item:last-child {
            border-bottom: none;
        }
        
        .transaction-item:hover {
            background: #f8f9fa;
        }

        /* åŒæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
        .sync-status {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .sync-status.show {
            opacity: 1;
        }

        /* ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã‚¿ãƒ– */
        .settings-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .settings-section h3 {
            margin-bottom: 20px;
            color: #495057;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
        }

        /* ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ãªã‚¹ã‚¿ã‚¤ãƒ« */
        .clickable {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .clickable:hover {
            color: #8b5cf6;
            text-decoration: underline;
        }

        /* ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .password-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1500;
        }
        
        .password-modal.show {
            display: flex;
        }
        
        .password-modal-content {
            background: white;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            padding: 30px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        }
        
        .password-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        
        .password-form input {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .password-form input:focus {
            outline: none;
            border-color: #8b5cf6;
        }
        
        .password-error {
            color: #dc2626;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .password-success {
            color: #10b981;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        /* OCRé–¢é€£ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .ocr-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1500;
            overflow-y: auto;
        }
        
        .ocr-modal.show {
            display: flex;
        }
        
        .ocr-modal-content {
            background: white;
            border-radius: 15px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        }
        
        .ocr-options {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
        }
        
        .ocr-preview {
            max-width: 100%;
            margin: 20px 0;
            text-align: center;
        }
        
        .ocr-preview img {
            max-width: 100%;
            max-height: 400px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
        }
        
        .ocr-results {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .ocr-confirm-table {
            width: 100%;
            margin: 15px 0;
        }
        
        .ocr-confirm-table td {
            padding: 10px;
            vertical-align: middle;
        }
        
        .ocr-confirm-table input {
            width: 80px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }
        
        .ocr-loading {
            text-align: center;
            padding: 40px;
        }
        
        .ocr-loading-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #8b5cf6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .ocr-template {
            background: white;
            padding: 30px;
            font-family: 'ãƒ¡ã‚¤ãƒªã‚ª', 'Meiryo', sans-serif;
            font-size: 16pt;
            line-height: 2.5;
            color: black;
        }
        
        .ocr-template h2 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 24pt;
        }
        
        .ocr-template .ocr-item {
            margin: 15px 0;
            font-size: 18pt;
        }
        
        .ocr-template .checkbox {
            display: inline-block;
            width: 25px;
            height: 25px;
            border: 3px solid black;
            margin-right: 15px;
            vertical-align: middle;
        }
        
        .ocr-staff-select {
            margin: 20px 0;
            text-align: center;
        }
        
        .ocr-staff-select select {
            padding: 10px 20px;
            font-size: 1.1rem;
            border: 2px solid #8b5cf6;
            border-radius: 8px;
            background: white;
        }

        /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                margin: 0;
                border-radius: 10px;
            }
            
            .header {
                padding: 20px 15px;
                position: relative;
            }
            
            .header h1 {
                font-size: 1.8rem;
                margin-bottom: 5px;
            }
            
            .header p {
                font-size: 0.9rem;
            }
            
            .cloud-status {
                position: static;
                justify-content: center;
                margin-bottom: 15px;
                gap: 10px;
            }
            
            .user-info {
                position: static;
                justify-content: center;
                margin-bottom: 15px;
                gap: 10px;
            }
            
            .nav-tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                white-space: nowrap;
            }
            
            .nav-tab {
                flex: none;
                min-width: 120px;
                padding: 15px 10px;
                font-size: 0.95rem;
            }
            
            .content {
                padding: 20px 15px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
                margin-bottom: 20px;
            }
            
            .stat-card {
                padding: 20px 15px;
            }
            
            .stat-info .number {
                font-size: 2rem;
            }
            
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            table {
                min-width: 600px;
                font-size: 0.9rem;
            }
            
            th, td {
                padding: 10px 8px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .modal-content {
                width: 95%;
                margin: 20px;
                max-height: 85vh;
            }
            
            .modal-body {
                padding: 20px 15px;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 15px 10px;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .header p {
                font-size: 0.8rem;
            }
            
            .user-info {
                flex-direction: column;
                gap: 8px;
            }
            
            .save-btn, .logout-btn {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
            
            .nav-tab {
                min-width: 100px;
                padding: 12px 8px;
                font-size: 0.85rem;
            }
            
            .content {
                padding: 15px 10px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .stat-card {
                padding: 15px;
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            
            .stat-info .number {
                font-size: 1.8rem;
            }
            
            .stat-icon {
                width: 40px;
                height: 40px;
            }
            
            .btn {
                padding: 10px 16px;
                font-size: 0.9rem;
                margin-bottom: 5px;
            }
            
            .flex.justify-between {
                flex-direction: column;
                gap: 10px;
            }
            
            .flex.gap-10 {
                flex-direction: column;
                gap: 8px;
            }
            
            table {
                font-size: 0.8rem;
                min-width: 500px;
            }
            
            th, td {
                padding: 8px 6px;
            }
            
            .form-control {
                padding: 10px;
                font-size: 0.9rem;
            }
            
            .alert {
                padding: 15px;
                font-size: 0.9rem;
            }
            
            .login-box {
                padding: 30px 20px;
                margin: 10px;
            }
            
            .login-header h1 {
                font-size: 1.6rem;
            }
            
            .login-form input {
                padding: 12px;
                font-size: 0.9rem;
            }
            
            .login-btn {
                padding: 12px;
                font-size: 1rem;
            }
            
            .settings-section {
                padding: 20px 15px;
            }
            
            .settings-section h3 {
                font-size: 1.1rem;
            }
            
            .modal-content {
                width: 98%;
                margin: 10px;
                max-height: 90vh;
            }
            
            .modal-header {
                padding: 20px 15px;
            }
            
            .modal-header h2 {
                font-size: 1.3rem;
            }
            
            .confirm-content {
                padding: 25px 20px;
                margin: 10px;
            }
            
            .confirm-title {
                font-size: 1.3rem;
            }
            
            .confirm-icon {
                font-size: 3rem;
            }
        }
    </style>
</head>
<body>
    <!-- Firebaseè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="firebaseSetup" class="firebase-setup">
        <div class="firebase-setup-content">
            <h2 style="text-align: center; margin-bottom: 30px; color: #ec4899;">ğŸ”¥ Firebaseè¨­å®š</h2>
            
            <div class="setup-step">
                <h3>ã‚¹ãƒ†ãƒƒãƒ—1: Firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ</h3>
                <p>1. <a href="https://console.firebase.google.com/" target="_blank">Firebase Console</a>ã«ã‚¢ã‚¯ã‚»ã‚¹</p>
                <p>2. ã€Œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯</p>
                <p>3. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå: ã€Œç¾å®¹å®¤åœ¨åº«ç®¡ç†ã€</p>
                <p>4. Firestoreãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æœ‰åŠ¹åŒ–</p>
            </div>
            
            <div class="setup-step">
                <h3>ã‚¹ãƒ†ãƒƒãƒ—2: Web ã‚¢ãƒ—ãƒªã‚’è¿½åŠ </h3>
                <p>1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®š â†’ å…¨èˆ¬</p>
                <p>2. ã€Œã‚¢ãƒ—ãƒªã‚’è¿½åŠ ã€â†’ Web ã‚¢ã‚¤ã‚³ãƒ³</p>
                <p>3. ã‚¢ãƒ—ãƒªå: ã€Œç¾å®¹å®¤åœ¨åº«ç®¡ç†ã€</p>
                <p>4. è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚³ãƒ”ãƒ¼</p>
            </div>
            
            <div class="setup-step">
                <h3>ã‚¹ãƒ†ãƒƒãƒ—3: è¨­å®šã‚’è²¼ã‚Šä»˜ã‘</h3>
                <textarea id="firebaseConfig" class="config-input" rows="10" placeholder="Firebaseè¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„...

ä¾‹:
{
  apiKey: &quot;your-api-key&quot;,
  authDomain: &quot;your-project.firebaseapp.com&quot;,
  projectId: &quot;your-project-id&quot;,
  storageBucket: &quot;your-project.appspot.com&quot;,
  messagingSenderId: &quot;123456789&quot;,
  appId: &quot;your-app-id&quot;
}"></textarea>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-primary" onclick="setupFirebase()">ğŸš€ è¨­å®šå®Œäº†</button>
                <button class="btn" onclick="useLocalStorage()" style="background: #6c757d; color: white; margin-left: 10px;">ğŸ“± ãƒ­ãƒ¼ã‚«ãƒ«ã§ä½¿ç”¨</button>
            </div>
        </div>
    </div>

    <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
    <div id="loginContainer" class="login-container" style="display: none;">
        <div class="login-box">
            <div class="login-header">
                <h1>ç¾å®¹å®¤åœ¨åº«ç®¡ç† â˜ï¸</h1>
                <p style="color: #6c757d;">ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸç‰ˆ</p>
            </div>
            <form class="login-form" onsubmit="return login(event)">
                <input type="text" id="loginUsername" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å" required value="admin">
                <input type="password" id="loginPassword" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" required value="password">
                <button type="submit" class="login-btn">ãƒ­ã‚°ã‚¤ãƒ³</button>
            </form>
            <div style="text-align: center; margin-top: 20px; color: #6c757d; font-size: 0.9rem;">
                <strong>ãƒ‡ãƒ¢ç”¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</strong><br>
                ãƒ¦ãƒ¼ã‚¶ãƒ¼å: admin<br>
                ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: password<br>
                <small>ï¼ˆãƒ‡ãƒ¼ã‚¿ã¯ã‚¯ãƒ©ã‚¦ãƒ‰ã«åŒæœŸã•ã‚Œã¾ã™ï¼‰</small>
            </div>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div id="mainApp" class="container" style="display: none;">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="header">
            <div class="cloud-status">
                <div class="cloud-indicator" id="cloudIndicator"></div>
                <span id="cloudStatus">ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸä¸­...</span>
            </div>
            <div class="user-info">
                <button class="save-btn" onclick="saveToCloud()">
                    â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰ä¿å­˜
                </button>
                <span id="currentUserName">ğŸ‘¤ admin</span>
                <button class="logout-btn" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
            <h1>ç¾å®¹å®¤åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  â˜ï¸</h1>
            <p>ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ç¾å®¹å®¤å‘ã‘ç·åˆåœ¨åº«ç®¡ç† - ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸç‰ˆ</p>
        </div>

        <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¿ãƒ– -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">
                ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
            </button>
            <button class="nav-tab" onclick="showTab('products')">
                ğŸ“¦ å•†å“ãƒã‚¹ã‚¿
            </button>
            <button class="nav-tab" onclick="showTab('staff')">
                ğŸ‘¥ ã‚¹ã‚¿ãƒƒãƒ•ãƒã‚¹ã‚¿
            </button>
            <button class="nav-tab" onclick="showTab('transactions')">
                ğŸ“‹ å–å¼•è¨˜éŒ²
            </button>
            <button class="nav-tab" onclick="showTab('reports')">
                ğŸ“ˆ æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆ
            </button>
            <button class="nav-tab" onclick="showTab('settings')">
                âš™ï¸ è¨­å®š
            </button>
        </div>

        <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ -->
        <div class="content">
            <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚¿ãƒ– -->
            <div id="dashboard" class="tab-content active">
                <!-- çµ±è¨ˆã‚«ãƒ¼ãƒ‰ -->
                <div class="stats-grid">
                    <div class="stat-card pink">
                        <div class="stat-info">
                            <h3>ç·å•†å“æ•°</h3>
                            <div class="number" id="dashboard-total-products">12</div>
                        </div>
                        <div class="stat-icon">ğŸ“¦</div>
                    </div>
                    <div class="stat-card orange">
                        <div class="stat-info">
                            <h3>è¦æ³¨æ„åœ¨åº«</h3>
                            <div class="number" id="dashboard-warning-stock">3</div>
                        </div>
                        <div class="stat-icon">âš ï¸</div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-info">
                            <h3>é©æ­£åœ¨åº«</h3>
                            <div class="number" id="dashboard-optimal-stock">8</div>
                        </div>
                        <div class="stat-icon">âœ…</div>
                    </div>
                    <div class="stat-card blue">
                        <div class="stat-info">
                            <h3>æ£šå¸ã—é‡‘é¡</h3>
                            <div class="number" id="dashboard-inventory-value">Â¥234K</div>
                        </div>
                        <div class="stat-icon">ğŸ’°</div>
                    </div>
                </div>

                <!-- ã‚¢ãƒ©ãƒ¼ãƒˆ -->
                <div class="alert" id="stock-alert">
                    <strong>âš ï¸ åœ¨åº«ä¸è¶³å•†å“ãŒã‚ã‚Šã¾ã™</strong><br>
                    <span id="alert-details">ç·Šæ€¥: 1å“ç›®, è¦æ³¨æ„: 2å“ç›®ã®å•†å“ã§åœ¨åº«ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚æ—©æ€¥ãªç™ºæ³¨ã‚’ã”æ¤œè¨ãã ã•ã„ã€‚</span>
                </div>

                <!-- åœ¨åº«çŠ¶æ³ãƒ†ãƒ¼ãƒ–ãƒ« -->
                <div class="table-container">
                    <div class="table-header">
                        <h3>åœ¨åº«çŠ¶æ³ä¸€è¦§ï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸï¼‰</h3>
                        <button class="btn btn-secondary" onclick="loadCloudData()">ğŸ”„ æœ€æ–°ãƒ‡ãƒ¼ã‚¿å–å¾—</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>å•†å“å</th>
                                <th>ç¾åœ¨åº«</th>
                                <th>é©æ­£åœ¨åº«</th>
                                <th>å·®ç•°</th>
                                <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                <th>åœ¨åº«é‡‘é¡</th>
                            </tr>
                        </thead>
                        <tbody id="dashboard-stock-table">
                            <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- å•†å“ãƒã‚¹ã‚¿ã‚¿ãƒ– -->
            <div id="products" class="tab-content">
                <div class="flex justify-between" style="margin-bottom: 20px;">
                    <h2>å•†å“ãƒã‚¹ã‚¿ç®¡ç†ï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸï¼‰</h2>
                    <div class="flex gap-10">
                        <button class="btn btn-secondary" onclick="showCsvModal('products')">
                            ğŸ“¤ CSVä¸€æ‹¬ç™»éŒ²
                        </button>
                        <button class="btn btn-primary" onclick="showAddProductForm()">
                            â• å•†å“è¿½åŠ 
                        </button>
                    </div>
                </div>

                <!-- å•†å“è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
                <div id="addProductForm" class="table-container hidden" style="margin-bottom: 20px;">
                    <div class="table-header">
                        <h3>æ–°ã—ã„å•†å“ã‚’è¿½åŠ </h3>
                    </div>
                    <div style="padding: 20px;">
                        <div class="form-grid">
                            <input type="text" class="form-control" placeholder="å•†å“å" id="productName">
                            <input type="number" class="form-control" placeholder="é©æ­£åœ¨åº«æ•°" id="optimalStock">
                            <input type="number" class="form-control" placeholder="å˜ä¾¡" id="unitPrice">
                            <input type="text" class="form-control" placeholder="ä»•å…¥å…ˆ *å¿…é ˆ" id="supplier">
                            <select class="form-control" id="category">
                                <option value="ã‚«ãƒ©ãƒ¼å‰¤">ã‚«ãƒ©ãƒ¼å‰¤</option>
                                <option value="ã‚·ãƒ£ãƒ³ãƒ—ãƒ¼">ã‚·ãƒ£ãƒ³ãƒ—ãƒ¼</option>
                                <option value="ãƒˆãƒªãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆ">ãƒˆãƒªãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆ</option>
                                <option value="ãƒ‘ãƒ¼ãƒæ¶²">ãƒ‘ãƒ¼ãƒæ¶²</option>
                                <option value="ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°">ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°</option>
                                <option value="ãã®ä»–">ãã®ä»–</option>
                            </select>
                        </div>
                        <div class="flex gap-10">
                            <button class="btn btn-primary" onclick="addProduct()">è¿½åŠ </button>
                            <button class="btn" onclick="hideAddProductForm()" style="background: #6c757d; color: white;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        </div>
                    </div>
                </div>

                <!-- å•†å“ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ« -->
                <div class="table-container">
                    <div class="table-header">
                        <h3>å•†å“ä¸€è¦§</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>å•†å“å</th>
                                <th>ã‚«ãƒ†ã‚´ãƒª</th>
                                <th>ç¾åœ¨åº«</th>
                                <th>é©æ­£åœ¨åº«</th>
                                <th>å˜ä¾¡</th>
                                <th>ä»•å…¥å…ˆ</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody">
                            <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ã‚¹ã‚¿ãƒƒãƒ•ãƒã‚¹ã‚¿ã‚¿ãƒ– -->
            <div id="staff" class="tab-content">
                <div class="flex justify-between" style="margin-bottom: 20px;">
                    <h2>ã‚¹ã‚¿ãƒƒãƒ•ãƒã‚¹ã‚¿ç®¡ç†ï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸï¼‰</h2>
                    <button class="btn btn-secondary" onclick="showCsvModal('staff')">
                        ğŸ“¤ CSVä¸€æ‹¬ç™»éŒ²
                    </button>
                </div>

                <div class="table-container">
                    <div class="table-header">
                        <h3>ã‚¹ã‚¿ãƒƒãƒ•ä¸€è¦§</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>ã‚¹ã‚¿ãƒƒãƒ•ã‚³ãƒ¼ãƒ‰</th>
                                <th>æ°å</th>
                                <th>å½¹è·</th>
                                <th>åœ¨ç±çŠ¶æ³</th>
                                <th>å…¥ç¤¾æ—¥</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="staffTableBody">
                            <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- å–å¼•è¨˜éŒ²ã‚¿ãƒ– -->
            <div id="transactions" class="tab-content">
                <div class="flex justify-between" style="margin-bottom: 20px;">
                    <h2>å–å¼•è¨˜éŒ²ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸï¼‰</h2>
                    <div class="flex gap-10">
                        <button class="btn btn-secondary" onclick="showOCRModal()">ğŸ“¸ ç´™ã®è¨˜éŒ²ã‚’èª­ã¿å–ã‚Š</button>
                        <button class="btn btn-primary" onclick="showAddTransactionForm()">â• å–å¼•è¿½åŠ </button>
                    </div>
                </div>

                <!-- å–å¼•è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
                <div id="addTransactionForm" class="table-container hidden" style="margin-bottom: 20px;">
                    <div class="table-header">
                        <h3>æ–°ã—ã„å–å¼•ã‚’è¿½åŠ </h3>
                    </div>
                    <div style="padding: 20px;">
                        <div class="form-grid">
                            <select class="form-control" id="transactionProduct">
                                <option value="">å•†å“ã‚’é¸æŠ</option>
                            </select>
                            <select class="form-control" id="transactionType">
                                <option value="order">ç™ºæ³¨</option>
                                <option value="receipt">å…¥è·</option>
                                <option value="use">ä½¿ç”¨</option>
                                <option value="sale">è²©å£²</option>
                            </select>
                            <input type="number" class="form-control" placeholder="æ•°é‡" id="transactionQuantity">
                            <select class="form-control" id="transactionStaff">
                                <option value="">æ‹…å½“è€…ã‚’é¸æŠ</option>
                            </select>
                            <input type="text" class="form-control" placeholder="ãƒ¡ãƒ¢" id="transactionMemo">
                        </div>
                        <div class="flex gap-10">
                            <button class="btn btn-primary" onclick="addTransaction()">è¿½åŠ </button>
                            <button class="btn" onclick="hideAddTransactionForm()" style="background: #6c757d; color: white;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <div class="table-header">
                        <h3>æœ€è¿‘ã®å–å¼•å±¥æ­´</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>æ—¥ä»˜ãƒ»æ™‚åˆ»</th>
                                <th>å•†å“</th>
                                <th>ç¨®åˆ¥</th>
                                <th>æ•°é‡</th>
                                <th>æ‹…å½“è€…</th>
                                <th>ãƒ¡ãƒ¢</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsTableBody">
                            <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆã‚¿ãƒ– -->
            <div id="reports" class="tab-content">
                <h2 style="margin-bottom: 20px;">æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰é›†è¨ˆï¼‰</h2>
                
                <div class="stats-grid" style="margin-bottom: 30px;">
                    <div class="stat-card blue">
                        <div class="stat-info">
                            <h3>å½“æœˆç™ºæ³¨é¡</h3>
                            <div class="number" id="monthly-amount">Â¥0</div>
                        </div>
                        <div class="stat-icon">ğŸ’°</div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-info">
                            <h3>ä»•å…¥å…ˆæ•°</h3>
                            <div class="number" id="supplier-count">0</div>
                        </div>
                        <div class="stat-icon">ğŸ¢</div>
                    </div>
                    <div class="stat-card orange">
                        <div class="stat-info">
                            <h3>å–å¼•ä»¶æ•°</h3>
                            <div class="number clickable" id="transaction-count" onclick="showTransactionDetails()">0</div>
                        </div>
                        <div class="stat-icon">ğŸ“‹</div>
                    </div>
                    <div class="stat-card pink">
                        <div class="stat-info">
                            <h3>æœ€æ–°æ›´æ–°</h3>
                            <div class="number" id="last-update" style="font-size: 1.2rem;">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ </div>
                        </div>
                        <div class="stat-icon">ğŸ”„</div>
                    </div>
                </div>

                <div class="table-container">
                    <div class="table-header">
                        <h3>ä»•å…¥å…ˆåˆ¥ç™ºæ³¨é›†è¨ˆï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ï¼‰</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>ä»•å…¥å…ˆ</th>
                                <th>é‡‘é¡</th>
                                <th>å‰²åˆ</th>
                                <th>å–å¼•å›æ•°</th>
                                <th>å¹³å‡å˜ä¾¡</th>
                            </tr>
                        </thead>
                        <tbody id="supplier-report-tbody">
                            <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- è¨­å®šã‚¿ãƒ– -->
            <div id="settings" class="tab-content">
                <h2 style="margin-bottom: 20px;">ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰ç‰ˆï¼‰</h2>

                <!-- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="settings-section">
                    <h3>ğŸ‘¤ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š</h3>
                    <div style="margin-top: 20px;">
                        <div style="margin-bottom: 15px;">
                            <strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼å:</strong> <span id="settingsUsername">admin</span>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <strong>è¡¨ç¤ºå:</strong> <span id="settingsDisplayName">ç®¡ç†è€…</span>
                        </div>
                        <div style="margin-top: 20px;">
                            <button class="btn btn-primary" onclick="showPasswordModal()">ğŸ” ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</button>
                        </div>
                    </div>
                </div>

                <!-- ã‚¯ãƒ©ã‚¦ãƒ‰è¨­å®š -->
                <div class="settings-section">
                    <h3>â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰è¨­å®š</h3>
                    <div style="margin-top: 20px;">
                        <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                            <button class="btn btn-primary" onclick="forceSync()">ğŸ”„ å¼·åˆ¶åŒæœŸ</button>
                            <button class="btn" onclick="clearCloudData()" style="background: #dc2626; color: white;">ğŸ—‘ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
                        </div>
                        
                        <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <h4>ğŸ“Š åŒæœŸçµ±è¨ˆ</h4>
                            <div style="margin-top: 10px; font-size: 0.9rem;">
                                <div>æœ€çµ‚åŒæœŸ: <span id="lastSync">æœªåŒæœŸ</span></div>
                                <div>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID: <span id="projectId">æœªè¨­å®š</span></div>
                                <div>åŒæœŸçŠ¶æ…‹: <span id="syncState">åˆæœŸåŒ–ä¸­</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç† -->
                <div class="settings-section">
                    <h3>ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
                    <div style="display: grid; gap: 15px;">
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <button class="btn btn-primary" onclick="exportData()">
                                ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                            </button>
                            <span style="color: #6c757d; font-size: 0.9rem;">ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã§ä¿å­˜</span>
                        </div>
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <button class="btn btn-secondary" onclick="importData()">
                                ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                            </button>
                            <span style="color: #6c757d; font-size: 0.9rem;">JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ</span>
                        </div>
                    </div>
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <h4 style="margin-bottom: 10px;">ğŸ“Š ãƒ‡ãƒ¼ã‚¿çµ±è¨ˆ</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; font-size: 0.9rem;">
                            <div>ğŸ“¦ å•†å“ãƒã‚¹ã‚¿: <strong id="stats-products">0</strong>ä»¶</div>
                            <div>ğŸ‘¥ ã‚¹ã‚¿ãƒƒãƒ•ãƒã‚¹ã‚¿: <strong id="stats-staff">0</strong>ä»¶</div>
                            <div>ğŸ“‹ å–å¼•è¨˜éŒ²: <strong id="stats-transactions">0</strong>ä»¶</div>
                            <div>ğŸ’¾ æœ€çµ‚ä¿å­˜: <strong id="stats-last-save">æœªä¿å­˜</strong></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="passwordModal" class="password-modal">
        <div class="password-modal-content">
            <div class="modal-header">
                <h2>ğŸ” ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</h2>
                <button onclick="closePasswordModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">âœ•</button>
            </div>
            <div class="modal-body">
                <form class="password-form" onsubmit="return changePassword(event)">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                        <input type="password" id="currentPassword" required placeholder="ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                        <input type="password" id="newPassword" required placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" minlength="6">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰</label>
                        <input type="password" id="confirmPassword" required placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å†å…¥åŠ›">
                    </div>
                    <div id="passwordError" class="password-error" style="display: none;"></div>
                    <div id="passwordSuccess" class="password-success" style="display: none;"></div>
                    <div class="flex gap-10" style="margin-top: 20px;">
                        <button type="submit" class="btn btn-primary">å¤‰æ›´</button>
                        <button type="button" class="btn" onclick="closePasswordModal()" style="background: #6c757d; color: white;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- CSVä¸€æ‹¬ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="csvModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>CSVä¸€æ‹¬ç™»éŒ²ï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸï¼‰</h2>
                <button onclick="closeCsvModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">âœ•</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <h3>ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ‡ãƒ¼ã‚¿ç¨®åˆ¥ã‚’é¸æŠ</h3>
                    <div class="flex gap-10" style="margin-top: 10px;">
                        <button id="productTypeBtn" class="btn btn-primary" onclick="setCsvType('products')">å•†å“ãƒã‚¹ã‚¿</button>
                        <button id="staffTypeBtn" class="btn" onclick="setCsvType('staff')" style="background: #6c757d; color: white;">ã‚¹ã‚¿ãƒƒãƒ•ãƒã‚¹ã‚¿</button>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <h3>ã‚¹ãƒ†ãƒƒãƒ—2: CSVãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</h3>
                    <button class="btn btn-secondary" onclick="downloadTemplate()">
                        ğŸ“¥ CSVãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    </button>
                    <p style="margin-top: 10px; color: #6c757d; font-size: 0.9rem;" id="templateInfo">
                        å•†å“ãƒã‚¹ã‚¿å¿…é ˆé …ç›®: name(å•†å“å), currentStock(ç¾åœ¨åº«), optimalStock(é©æ­£åœ¨åº«), supplier(ä»•å…¥ã‚Œå…ˆ) â€»unitPrice(å˜ä¾¡)ã¯ç©ºç™½å¯
                    </p>
                </div>

                <div style="margin-bottom: 20px;">
                    <h3>ã‚¹ãƒ†ãƒƒãƒ—3: CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
                    <div class="upload-zone" id="uploadZone" onclick="document.getElementById('csvFile').click()">
                        <div style="font-size: 3rem; margin-bottom: 10px;">ğŸ“¤</div>
                        <p style="font-size: 1.1rem; margin-bottom: 10px;">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</p>
                        <p style="color: #6c757d; margin-bottom: 10px;">ã¾ãŸã¯</p>
                        <button class="btn btn-secondary">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</button>
                    </div>
                    <input type="file" id="csvFile" accept=".csv" style="display: none;" onchange="handleFileSelect(event)">
                </div>

                <div id="csvPreview" class="hidden">
                    <h3>ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                    <div id="errorSummary" class="error-list hidden">
                        <strong>âš ï¸ ã‚¨ãƒ©ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ</strong>
                        <div id="errorDetails"></div>
                    </div>
                    <div class="csv-preview">
                        <table id="previewTable">
                            <thead id="previewHeader"></thead>
                            <tbody id="previewBody"></tbody>
                        </table>
                    </div>
                    <div class="flex justify-between" style="margin-top: 20px;">
                        <button class="btn" onclick="clearCsvData()" style="background: #6c757d; color: white;">ã‚¯ãƒªã‚¢</button>
                        <button class="btn btn-primary" id="importBtn" onclick="importCsvData()">
                            <span id="importBtnText">ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="confirmModal" class="confirm-modal">
        <div class="confirm-content">
            <div class="confirm-icon">âš ï¸</div>
            <div class="confirm-title" id="confirmTitle">å‰Šé™¤ã®ç¢ºèª</div>
            <div class="confirm-message" id="confirmMessage">ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚</div>
            <div class="confirm-buttons">
                <button class="btn" onclick="closeConfirmModal()" style="background: #6c757d; color: white;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn" onclick="executeDelete()" style="background: #dc2626; color: white;">å®Œå…¨å‰Šé™¤</button>
            </div>
        </div>
    </div>

    <!-- å–å¼•è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="transactionDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>å½“æœˆã®ç™ºæ³¨è©³ç´°</h2>
                <button onclick="closeTransactionDetailModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">âœ•</button>
            </div>
            <div class="modal-body">
                <div id="transactionDetailContent" class="transaction-details">
                    <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
                </div>
            </div>
        </div>
    </div>

    <!-- OCRãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="ocrModal" class="ocr-modal">
        <div class="ocr-modal-content">
            <div class="modal-header">
                <h2>ğŸ“¸ ä½¿ç”¨è¨˜éŒ²ã®èª­ã¿å–ã‚Š</h2>
                <button onclick="closeOCRModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="ocr-options">
                    <button onclick="selectImageFile()" class="btn btn-primary">
                        ğŸ“ ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                    </button>
                    <button onclick="printOCRTemplate()" class="btn btn-secondary">
                        ğŸ–¨ï¸ è¨˜éŒ²ç”¨ç´™ã‚’å°åˆ·
                    </button>
                </div>
                
                <input type="file" id="ocrFileInput" accept="image/*" style="display: none;" onchange="handleOCRFile(event)">
                
                <div id="ocrPreview" class="ocr-preview" style="display: none;"></div>
                
                <div id="ocrLoading" class="ocr-loading" style="display: none;">
                    <div class="ocr-loading-spinner"></div>
                    <p style="margin-top: 20px;">ç”»åƒã‚’è§£æä¸­...</p>
                </div>
                
                <div id="ocrResults" class="ocr-results" style="display: none;">
                    <h3>èªè­˜çµæœã®ç¢ºèª</h3>
                    <div class="ocr-staff-select">
                        <label>æ‹…å½“ã‚¹ã‚¿ãƒƒãƒ•: </label>
                        <select id="ocrStaffSelect">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        </select>
                    </div>
                    <table class="ocr-confirm-table" id="ocrConfirmTable">
                        <thead>
                            <tr>
                                <th>å•†å“å</th>
                                <th>æ•°é‡</th>
                                <th>å˜ä½</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="ocrTableBody">
                        </tbody>
                    </table>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn" onclick="addOCRRow()" style="background: #6c757d; color: white; margin-right: 10px;">
                            â• å•†å“è¿½åŠ 
                        </button>
                        <button class="btn btn-primary" onclick="confirmOCRRecords()">
                            âœ… ç¢ºå®šã—ã¦è¨˜éŒ²
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- OCRå°åˆ·ç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ -->
    <div id="ocrPrintTemplate" style="display: none;">
        <div class="ocr-template">
            <h2>åœ¨åº«ä½¿ç”¨è¨˜éŒ²ã‚·ãƒ¼ãƒˆ</h2>
            <p>æ—¥ä»˜: ________________</p>
            <p>æ‹…å½“: ________________</p>
            <hr style="margin: 20px 0;">
            
            <div class="ocr-items">
                <div class="ocr-item">
                    <span class="checkbox">â–¡</span>
                    ã‚«ãƒ©ãƒ¼å‰¤6ç•ª _______ æœ¬
                </div>
                <div class="ocr-item">
                    <span class="checkbox">â–¡</span>
                    ã‚«ãƒ©ãƒ¼å‰¤8ç•ª _______ æœ¬
                </div>
                <div class="ocr-item">
                    <span class="checkbox">â–¡</span>
                    ãƒŸãƒ«ãƒœãƒ³ ã‚·ãƒ£ãƒ³ãƒ—ãƒ¼ _______ æœ¬
                </div>
                <div class="ocr-item">
                    <span class="checkbox">â–¡</span>
                    ãƒˆãƒªãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆ _______ æœ¬
                </div>
                <div class="ocr-item">
                    <span class="checkbox">â–¡</span>
                    ã‚¦ã‚¨ãƒ© ãƒ‘ãƒ¼ãƒæ¶² _______ æœ¬
                </div>
                <div class="ocr-item">
                    <span class="checkbox">â–¡</span>
                    N. ã‚ªã‚¤ãƒ« _______ æœ¬
                </div>
                <div class="ocr-item">
                    <span class="checkbox">â–¡</span>
                    ãã®ä»–: _____________ _______ æœ¬
                </div>
            </div>
            
            <hr style="margin: 20px 0;">
            <p>å‚™è€ƒ: _________________________________</p>
        </div>
    </div>

    <!-- åŒæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
    <div id="syncStatus" class="sync-status">
        <span id="syncMessage">åŒæœŸä¸­...</span>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentUser = null;
        let users = {
            admin: { password: 'password', displayName: 'ç®¡ç†è€…', email: '', shopName: 'ç¾å®¹å®¤ã‚µãƒ³ãƒ—ãƒ«' }
        };
        let db = null;
        let isCloudMode = false;
        let syncInProgress = false;
        
        // ãƒ‡ãƒ¼ã‚¿é…åˆ—
        let products = [
            { id: 1, name: 'ãƒ­ãƒ¬ã‚¢ãƒ« ã‚«ãƒ©ãƒ¼å‰¤ 6ç•ª', category: 'ã‚«ãƒ©ãƒ¼å‰¤', currentStock: 15, optimalStock: 20, unitPrice: 1200, supplier: 'ãƒ­ãƒ¬ã‚¢ãƒ«' },
            { id: 2, name: 'ãƒŸãƒ«ãƒœãƒ³ ã‚·ãƒ£ãƒ³ãƒ—ãƒ¼', category: 'ã‚·ãƒ£ãƒ³ãƒ—ãƒ¼', currentStock: 8, optimalStock: 12, unitPrice: 2800, supplier: 'ãƒŸãƒ«ãƒœãƒ³' },
            { id: 3, name: 'ã‚¦ã‚¨ãƒ© ãƒ‘ãƒ¼ãƒæ¶²', category: 'ãƒ‘ãƒ¼ãƒæ¶²', currentStock: 5, optimalStock: 10, unitPrice: 1800, supplier: 'ã‚¦ã‚¨ãƒ©' },
            { id: 4, name: 'N. ã‚ªã‚¤ãƒ«', category: 'ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°', currentStock: 25, optimalStock: 15, unitPrice: 3400, supplier: 'ãƒŠãƒ—ãƒ©' }
        ];
        let staff = [
            { id: 1, name: 'ç”°ä¸­ç¾é¦™', role: 'åº—é•·', staffCode: 'ST001', joinDate: '2020-04-01' },
            { id: 2, name: 'ä½è—¤èŠ±å­', role: 'ã‚¹ã‚¿ã‚¤ãƒªã‚¹ãƒˆ', staffCode: 'ST002', joinDate: '2021-06-15' },
            { id: 3, name: 'å±±ç”°å¤ªéƒ', role: 'ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ', staffCode: 'ST003', joinDate: '2023-03-01' }
        ];
        let transactions = [
            { id: 1, productId: 1, type: 'order', quantity: 10, date: '2025-08-01', time: '10:30', staffName: 'ç”°ä¸­ç¾é¦™', memo: 'å®šæœŸç™ºæ³¨' },
            { id: 2, productId: 1, type: 'receipt', quantity: 10, date: '2025-08-01', time: '14:15', staffName: 'ä½è—¤èŠ±å­', memo: 'ç™ºæ³¨åˆ†å…¥è·' },
            { id: 3, productId: 2, type: 'order', quantity: 5, date: '2025-08-01', time: '16:20', staffName: 'å±±ç”°å¤ªéƒ', memo: 'ã‚·ãƒ£ãƒ³ãƒ—ãƒ¼ç™ºæ³¨' },
            { id: 4, productId: 4, type: 'receipt', quantity: 3, date: '2025-08-01', time: '11:45', staffName: 'ä½è—¤èŠ±å­', memo: 'ã‚ªã‚¤ãƒ«å…¥è·' },
            { id: 5, productId: 3, type: 'order', quantity: 8, date: '2025-08-01', time: '09:00', staffName: 'ç”°ä¸­ç¾é¦™', memo: 'ãƒ‘ãƒ¼ãƒæ¶²ç™ºæ³¨' }
        ];

        let editingProductId = null;
        let editingTransactionId = null;
        let currentCsvType = 'products';
        let csvData = [];
        let validationErrors = [];
        let pendingDeleteAction = null;
        let ocrRecords = []; // OCRèªè­˜çµæœã®ä¸€æ™‚ä¿å­˜

        // Firebase è¨­å®š
        function setupFirebase() {
            const configText = document.getElementById('firebaseConfig').value.trim();
            
            if (!configText) {
                alert('Firebaseè¨­å®šã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            try {
                // è¨­å®šæ–‡å­—åˆ—ã‚’è§£æ
                let config;
                if (configText.startsWith('{')) {
                    config = eval('(' + configText + ')');
                } else {
                    config = JSON.parse(configText);
                }
                
                // FirebaseåˆæœŸåŒ–
                firebase.initializeApp(config);
                db = firebase.firestore();
                isCloudMode = true;
                
                // è¨­å®šã‚’ä¿å­˜
                localStorage.setItem('firebaseConfig', JSON.stringify(config));
                
                // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†
                document.getElementById('firebaseSetup').style.display = 'none';
                document.getElementById('loginContainer').style.display = 'flex';
                
                updateCloudStatus('æ¥ç¶šæ¸ˆã¿', true);
                showSyncMessage('âœ… Firebaseæ¥ç¶šå®Œäº†ï¼');
                
            } catch (error) {
                alert('Firebaseè¨­å®šã«ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™: ' + error.message);
                console.error('Firebase setup error:', error);
            }
        }

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ¢ãƒ¼ãƒ‰ã§ä½¿ç”¨
        function useLocalStorage() {
            isCloudMode = false;
            document.getElementById('firebaseSetup').style.display = 'none';
            document.getElementById('loginContainer').style.display = 'flex';
            updateCloudStatus('ãƒ­ãƒ¼ã‚«ãƒ«', false);
        }

        // ãƒ­ã‚°ã‚¤ãƒ³
        function login(event) {
            if (event) event.preventDefault();
            
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            
            if (users[username] && users[username].password === password) {
                currentUser = username;
                document.getElementById('currentUserName').textContent = `ğŸ‘¤ ${users[username].displayName}`;
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                
                // è¨­å®šã‚¿ãƒ–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’æ›´æ–°
                document.getElementById('settingsUsername').textContent = username;
                document.getElementById('settingsDisplayName').textContent = users[username].displayName;
                
                initializeApp();
                
                if (isCloudMode) {
                    loadCloudData();
                }
                
                showSyncMessage('âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼');
                return true;
            } else {
                alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚');
                return false;
            }
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        function logout() {
            currentUser = null;
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('loginContainer').style.display = 'flex';
        }

        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showPasswordModal() {
            document.getElementById('passwordModal').classList.add('show');
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            document.getElementById('passwordError').style.display = 'none';
            document.getElementById('passwordSuccess').style.display = 'none';
        }

        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closePasswordModal() {
            document.getElementById('passwordModal').classList.remove('show');
        }

        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´å‡¦ç†
        function changePassword(event) {
            event.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorEl = document.getElementById('passwordError');
            const successEl = document.getElementById('passwordSuccess');
            
            // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒªã‚»ãƒƒãƒˆ
            errorEl.style.display = 'none';
            successEl.style.display = 'none';
            
            // ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯
            if (users[currentUser].password !== currentPassword) {
                errorEl.textContent = 'ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚';
                errorEl.style.display = 'block';
                return false;
            }
            
            // æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ç¢ºèª
            if (newPassword !== confirmPassword) {
                errorEl.textContent = 'æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚';
                errorEl.style.display = 'block';
                return false;
            }
            
            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®é•·ã•ãƒã‚§ãƒƒã‚¯
            if (newPassword.length < 6) {
                errorEl.textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§è¨­å®šã—ã¦ãã ã•ã„ã€‚';
                errorEl.style.display = 'block';
                return false;
            }
            
            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´å‡¦ç†
            users[currentUser].password = newPassword;
            
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
            localStorage.setItem('beautyInventoryUsers', JSON.stringify(users));
            
            // ã‚¯ãƒ©ã‚¦ãƒ‰ã«ã‚‚ä¿å­˜
            if (isCloudMode) {
                saveToCloud();
            }
            
            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
            successEl.textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£å¸¸ã«å¤‰æ›´ã•ã‚Œã¾ã—ãŸã€‚';
            successEl.style.display = 'block';
            
            // 1.5ç§’å¾Œã«ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            setTimeout(() => {
                closePasswordModal();
                showSyncMessage('ğŸ” ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
            }, 1500);
            
            return false;
        }

        // ã‚¢ãƒ—ãƒªåˆæœŸåŒ–
        function initializeApp() {
            // ä¿å­˜ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’èª­ã¿è¾¼ã‚€
            const savedUsers = localStorage.getItem('beautyInventoryUsers');
            if (savedUsers) {
                users = JSON.parse(savedUsers);
            }
            
            renderProductsTable();
            renderStaffTable();
            renderTransactionsTable();
            updateProductSelect();
            updateStaffSelect();
            updateDashboardStats();
            updateMonthlyReport();
            updateDataStats();
        }

        // ã‚¯ãƒ©ã‚¦ãƒ‰ã«ãƒ‡ãƒ¼ã‚¿ä¿å­˜
        async function saveToCloud() {
            if (!isCloudMode || !db) {
                // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰æ™‚ã¯å¾“æ¥ã®ä¿å­˜
                saveAllData();
                return;
            }
            
            if (syncInProgress) {
                showSyncMessage('â³ åŒæœŸå‡¦ç†ä¸­ã§ã™...');
                return;
            }
            
            syncInProgress = true;
            updateCloudStatus('åŒæœŸä¸­...', true);
            
            try {
                const batch = db.batch();
                
                // å•†å“ãƒ‡ãƒ¼ã‚¿ä¿å­˜
                products.forEach(product => {
                    const docRef = db.collection('products').doc(product.id.toString());
                    batch.set(docRef, product);
                });
                
                // ã‚¹ã‚¿ãƒƒãƒ•ãƒ‡ãƒ¼ã‚¿ä¿å­˜
                staff.forEach(member => {
                    const docRef = db.collection('staff').doc(member.id.toString());
                    batch.set(docRef, member);
                });
                
                // å–å¼•ãƒ‡ãƒ¼ã‚¿ä¿å­˜
                transactions.forEach(transaction => {
                    const docRef = db.collection('transactions').doc(transaction.id.toString());
                    batch.set(docRef, transaction);
                });
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚‚ä¿å­˜
                const usersRef = db.collection('settings').doc('users');
                batch.set(usersRef, { users: users });
                
                // ãƒãƒƒãƒå®Ÿè¡Œ
                await batch.commit();
                
                // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ä¿å­˜
                await db.collection('metadata').doc('lastSync').set({
                    timestamp: new Date(),
                    user: currentUser,
                    dataCount: {
                        products: products.length,
                        staff: staff.length,
                        transactions: transactions.length
                    }
                });
                
                updateCloudStatus('åŒæœŸå®Œäº†', true);
                showSyncMessage('â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰ä¿å­˜å®Œäº†ï¼');
                updateSyncStats();
                
            } catch (error) {
                console.error('Cloud save error:', error);
                updateCloudStatus('ã‚¨ãƒ©ãƒ¼', false);
                showSyncMessage('âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + error.message);
            } finally {
                syncInProgress = false;
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ä¿å­˜æ©Ÿèƒ½ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ç‰ˆäº’æ›ï¼‰
        function saveAllData() {
            try {
                const dataToSave = {
                    products: products,
                    staff: staff,
                    transactions: transactions,
                    users: users,
                    savedAt: new Date().toISOString(),
                    version: '1.0'
                };
                
                localStorage.setItem('beautyInventoryData', JSON.stringify(dataToSave));
                localStorage.setItem('beautyInventoryUsers', JSON.stringify(users));
                
                showSyncMessage('ğŸ’¾ ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜å®Œäº†ï¼');
                updateDataStats();
                
            } catch (error) {
                alert('âŒ ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\n' + error.message);
                console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadCloudData() {
            if (!isCloudMode || !db) {
                // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰æ™‚ã¯å¾“æ¥ã®èª­ã¿è¾¼ã¿
                loadAllData();
                return;
            }
            
            if (syncInProgress) return;
            
            syncInProgress = true;
            updateCloudStatus('èª­ã¿è¾¼ã¿ä¸­...', true);
            
            try {
                // å•†å“ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
                const productsSnapshot = await db.collection('products').get();
                if (!productsSnapshot.empty) {
                    products = [];
                    productsSnapshot.forEach(doc => {
                        products.push(doc.data());
                    });
                }
                
                // ã‚¹ã‚¿ãƒƒãƒ•ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
                const staffSnapshot = await db.collection('staff').get();
                if (!staffSnapshot.empty) {
                    staff = [];
                    staffSnapshot.forEach(doc => {
                        staff.push(doc.data());
                    });
                }
                
                // å–å¼•ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
                const transactionsSnapshot = await db.collection('transactions').get();
                if (!transactionsSnapshot.empty) {
                    transactions = [];
                    transactionsSnapshot.forEach(doc => {
                        transactions.push(doc.data());
                    });
                }
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±èª­ã¿è¾¼ã¿
                const usersDoc = await db.collection('settings').doc('users').get();
                if (usersDoc.exists) {
                    const data = usersDoc.data();
                    if (data.users) {
                        users = data.users;
                    }
                }
                
                // UIæ›´æ–°
                renderProductsTable();
                renderStaffTable();
                renderTransactionsTable();
                updateProductSelect();
                updateStaffSelect();
                updateDashboardStats();
                updateMonthlyReport();
                
                updateCloudStatus('åŒæœŸå®Œäº†', true);
                showSyncMessage('ğŸ“¥ ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†ï¼');
                updateSyncStats();
                
            } catch (error) {
                console.error('Cloud load error:', error);
                updateCloudStatus('ã‚¨ãƒ©ãƒ¼', false);
                showSyncMessage('âŒ èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message);
            } finally {
                syncInProgress = false;
            }
        }

        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æ©Ÿèƒ½ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ç‰ˆäº’æ›ï¼‰
        function loadAllData() {
            try {
                const savedData = localStorage.getItem('beautyInventoryData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    
                    if (data.products) products = data.products;
                    if (data.staff) staff = data.staff;
                    if (data.transactions) transactions = data.transactions;
                    if (data.users) users = data.users;
                    
                    console.log('ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ:', data.savedAt);
                    return true;
                } else {
                    console.log('ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚åˆå›èµ·å‹•ã§ã™ã€‚');
                    return false;
                }
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                return false;
            }
        }

        // å¼·åˆ¶åŒæœŸ
        async function forceSync() {
            await saveToCloud();
            setTimeout(() => loadCloudData(), 1000);
        }

        // ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
        async function clearCloudData() {
            if (!isCloudMode || !db) return;
            
            if (confirm('âš ï¸ è­¦å‘Š: ã‚¯ãƒ©ã‚¦ãƒ‰ã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ï¼')) {
                try {
                    const batch = db.batch();
                    
                    const collections = ['products', 'staff', 'transactions', 'metadata'];
                    
                    for (const collectionName of collections) {
                        const snapshot = await db.collection(collectionName).get();
                        snapshot.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                    }
                    
                    await batch.commit();
                    showSyncMessage('ğŸ—‘ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    
                } catch (error) {
                    alert('å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + error.message);
                }
            }
        }

        // UI æ›´æ–°é–¢æ•°
        function updateCloudStatus(message, isOnline) {
            const statusElement = document.getElementById('cloudStatus');
            const indicatorElement = document.getElementById('cloudIndicator');
            
            if (statusElement) statusElement.textContent = message;
            if (indicatorElement) {
                indicatorElement.className = isOnline ? 'cloud-indicator' : 'cloud-indicator offline';
            }
        }

        function showSyncMessage(message) {
            const syncStatus = document.getElementById('syncStatus');
            const syncMessage = document.getElementById('syncMessage');
            
            if (syncMessage) syncMessage.textContent = message;
            if (syncStatus) {
                syncStatus.classList.add('show');
                setTimeout(() => {
                    syncStatus.classList.remove('show');
                }, 3000);
            }
        }

        function updateSyncStats() {
            const lastSyncElement = document.getElementById('lastSync');
            const projectIdElement = document.getElementById('projectId');
            const syncStateElement = document.getElementById('syncState');
            
            if (lastSyncElement) {
                lastSyncElement.textContent = new Date().toLocaleString('ja-JP');
            }
            
            if (projectIdElement && isCloudMode) {
                const config = JSON.parse(localStorage.getItem('firebaseConfig') || '{}');
                projectIdElement.textContent = config.projectId || 'æœªè¨­å®š';
            }
            
            if (syncStateElement) {
                syncStateElement.textContent = isCloudMode ? 'ğŸŸ¢ ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸ' : 'ğŸ”µ ãƒ­ãƒ¼ã‚«ãƒ«';
            }
        }

        function updateDataStats() {
            const statsProducts = document.getElementById('stats-products');
            const statsStaff = document.getElementById('stats-staff');
            const statsTransactions = document.getElementById('stats-transactions');
            const statsLastSave = document.getElementById('stats-last-save');
            
            if (statsProducts) statsProducts.textContent = products.length;
            if (statsStaff) statsStaff.textContent = staff.length;
            if (statsTransactions) statsTransactions.textContent = transactions.length;
            
            if (statsLastSave) {
                try {
                    const savedData = localStorage.getItem('beautyInventoryData');
                    if (savedData) {
                        const data = JSON.parse(savedData);
                        const lastSave = new Date(data.savedAt).toLocaleString('ja-JP');
                        statsLastSave.textContent = lastSave;
                    } else {
                        statsLastSave.textContent = 'æœªä¿å­˜';
                    }
                } catch (error) {
                    statsLastSave.textContent = 'ã‚¨ãƒ©ãƒ¼';
                }
            }
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'dashboard') {
                updateDashboardStats();
            } else if (tabName === 'reports') {
                updateMonthlyReport();
            } else if (tabName === 'settings') {
                updateDataStats();
                updateSyncStats();
            }
        }

        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
        function updateDashboardStats() {
            const totalProducts = products.length;
            let criticalCount = 0;
            let warningCount = 0;
            let optimalCount = 0;
            let totalInventoryValue = 0;

            products.forEach(product => {
                const stockDiff = product.currentStock - product.optimalStock;
                const inventoryValue = product.currentStock * product.unitPrice;
                totalInventoryValue += inventoryValue;

                if (stockDiff <= -5) {
                    criticalCount++;
                } else if (stockDiff < 0) {
                    warningCount++;
                } else {
                    optimalCount++;
                }
            });

            // çµ±è¨ˆã‚«ãƒ¼ãƒ‰ã‚’æ›´æ–°
            const totalProductsEl = document.getElementById('dashboard-total-products');
            const warningStockEl = document.getElementById('dashboard-warning-stock');
            const optimalStockEl = document.getElementById('dashboard-optimal-stock');
            const inventoryValueEl = document.getElementById('dashboard-inventory-value');

            if (totalProductsEl) totalProductsEl.textContent = totalProducts;
            if (warningStockEl) warningStockEl.textContent = criticalCount + warningCount;
            if (optimalStockEl) optimalStockEl.textContent = optimalCount;
            if (inventoryValueEl) inventoryValueEl.textContent = `Â¥${Math.round(totalInventoryValue / 1000)}K`;

            // ã‚¢ãƒ©ãƒ¼ãƒˆã‚’æ›´æ–°
            const alertElement = document.getElementById('stock-alert');
            const alertDetails = document.getElementById('alert-details');
            
            if (alertElement && alertDetails) {
                if (criticalCount > 0 || warningCount > 0) {
                    alertDetails.textContent = `ç·Šæ€¥: ${criticalCount}å“ç›®, è¦æ³¨æ„: ${warningCount}å“ç›®ã®å•†å“ã§åœ¨åº«ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚æ—©æ€¥ãªç™ºæ³¨ã‚’ã”æ¤œè¨ãã ã•ã„ã€‚`;
                    alertElement.style.display = 'block';
                } else {
                    alertElement.style.display = 'none';
                }
            }

            updateDashboardStockTable();
        }

        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®åœ¨åº«çŠ¶æ³ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°
        function updateDashboardStockTable() {
            const tbody = document.getElementById('dashboard-stock-table');
            if (!tbody) return;
            
            tbody.innerHTML = '';

            products.forEach(product => {
                const stockDiff = product.currentStock - product.optimalStock;
                const inventoryValue = product.currentStock * product.unitPrice;
                
                let statusClass, statusText;
                if (stockDiff <= -5) {
                    statusClass = 'status-critical';
                    statusText = 'ç·Šæ€¥';
                } else if (stockDiff < 0) {
                    statusClass = 'status-low';
                    statusText = 'è¦æ³¨æ„';
                } else if (stockDiff > 5) {
                    statusClass = 'status-excess';
                    statusText = 'éå‰°';
                } else {
                    statusClass = 'status-optimal';
                    statusText = 'é©æ­£';
                }

                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>
                        <strong>${product.name}</strong><br>
                        <small>${product.category}</small>
                    </td>
                    <td>${product.currentStock} æœ¬</td>
                    <td>${product.optimalStock} æœ¬</td>
                    <td style="color: ${stockDiff < 0 ? '#dc2626' : '#059669'};">${stockDiff >= 0 ? '+' : ''}${stockDiff}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td>Â¥${inventoryValue.toLocaleString()}</td>
                `;
            });
        }

        // å•†å“ç®¡ç†é–¢é€£ã®é–¢æ•°ï¼ˆå…ƒã®æ©Ÿèƒ½ã‚’ã™ã¹ã¦å«ã‚€ï¼‰
        function showAddProductForm() {
            const form = document.getElementById('addProductForm');
            if (form) form.classList.remove('hidden');
        }

        function hideAddProductForm() {
            const form = document.getElementById('addProductForm');
            if (form) form.classList.add('hidden');
            clearProductForm();
        }

        function clearProductForm() {
            const elements = ['productName', 'optimalStock', 'unitPrice', 'supplier'];
            elements.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            
            const category = document.getElementById('category');
            if (category) category.value = 'ã‚«ãƒ©ãƒ¼å‰¤';
        }

        function addProduct() {
            const name = document.getElementById('productName').value;
            const optimalStock = document.getElementById('optimalStock').value;
            const unitPrice = document.getElementById('unitPrice').value;
            const supplier = document.getElementById('supplier').value;
            const category = document.getElementById('category').value;

            if (!name || !optimalStock || !supplier) {
                alert('å•†å“åãƒ»é©æ­£åœ¨åº«æ•°ãƒ»ä»•å…¥å…ˆã¯å¿…é ˆã§ã™ã€‚');
                return;
            }

            const maxId = products.length > 0 ? Math.max(...products.map(p => p.id)) : 0;
            const newProduct = {
                id: maxId + 1,
                name,
                category,
                currentStock: 0,
                optimalStock: parseInt(optimalStock),
                unitPrice: parseInt(unitPrice) || 0,
                supplier
            };

            products.push(newProduct);
            renderProductsTable();
            updateProductSelect();
            updateDashboardStats();
            updateMonthlyReport();
            hideAddProductForm();
            
            // è‡ªå‹•ä¿å­˜
            if (isCloudMode) {
                saveToCloud();
            } else {
                saveAllData();
            }
            
            alert('å•†å“ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼');
        }

        function renderProductsTable() {
            const tbody = document.getElementById('productsTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';

            products.forEach(product => {
                const row = tbody.insertRow();
                row.setAttribute('data-product-id', product.id);

                if (editingProductId === product.id) {
                    // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
                    row.innerHTML = `
                        <td><input type="text" class="form-control edit-name" value="${product.name}" style="width: 100%;"></td>
                        <td>${product.category}</td>
                        <td><input type="number" class="form-control edit-current-stock" value="${product.currentStock}" style="width: 80px;"> æœ¬</td>
                        <td><input type="number" class="form-control edit-optimal-stock" value="${product.optimalStock}" style="width: 80px;"> æœ¬</td>
                        <td><input type="number" class="form-control edit-unit-price" value="${product.unitPrice}" style="width: 100px;" placeholder="0"></td>
                        <td><input type="text" class="form-control edit-supplier" value="${product.supplier}" style="width: 100%;"></td>
                        <td>
                            <button class="btn" onclick="saveProductEdit(${product.id})" style="background: #10b981; color: white; padding: 6px 12px; font-size: 0.8rem; margin-right: 5px;">ä¿å­˜</button>
                            <button class="btn" onclick="cancelProductEdit()" style="background: #6c757d; color: white; padding: 6px 12px; font-size: 0.8rem;">å–æ¶ˆ</button>
                        </td>
                    `;
                } else {
                    // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰
                    row.innerHTML = `
                        <td>${product.name}</td>
                        <td>${product.category}</td>
                        <td>${product.currentStock} æœ¬</td>
                        <td>${product.optimalStock} æœ¬</td>
                        <td>Â¥${product.unitPrice.toLocaleString()}</td>
                        <td>${product.supplier}</td>
                        <td>
                            <button class="btn" onclick="editProduct(${product.id})" style="background: #3b82f6; color: white; padding: 6px 12px; font-size: 0.8rem; margin-right: 5px;">ç·¨é›†</button>
                            <button class="btn" onclick="deleteProduct(${product.id})" style="background: #dc2626; color: white; padding: 6px 12px; font-size: 0.8rem;">å‰Šé™¤</button>
                        </td>
                    `;
                }
            });
        }

        function editProduct(productId) {
            editingProductId = productId;
            renderProductsTable();
        }

        function saveProductEdit(productId) {
            const row = document.querySelector(`tr[data-product-id="${productId}"]`);
            const name = row.querySelector('.edit-name').value;
            const currentStock = parseInt(row.querySelector('.edit-current-stock').value);
            const optimalStock = parseInt(row.querySelector('.edit-optimal-stock').value);
            const unitPrice = parseInt(row.querySelector('.edit-unit-price').value) || 0;
            const supplier = row.querySelector('.edit-supplier').value;

            if (!name || !supplier) {
                alert('å•†å“åã¨ä»•å…¥å…ˆã¯å¿…é ˆã§ã™ã€‚');
                return;
            }

            const productIndex = products.findIndex(p => p.id === productId);
            if (productIndex !== -1) {
                products[productIndex] = {
                    ...products[productIndex],
                    name,
                    currentStock,
                    optimalStock,
                    unitPrice,
                    supplier
                };
            }

            editingProductId = null;
            renderProductsTable();
            updateProductSelect();
            updateDashboardStats();
            updateMonthlyReport();
            
            // è‡ªå‹•ä¿å­˜
            if (isCloudMode) {
                saveToCloud();
            } else {
                saveAllData();
            }
            
            alert('å•†å“æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼');
        }

        function cancelProductEdit() {
            editingProductId = null;
            renderProductsTable();
        }

        function deleteProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            if (confirm(`ã€Œ${product.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\né–¢é€£ã™ã‚‹å–å¼•è¨˜éŒ²ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚`)) {
                // é–¢é€£ã™ã‚‹å–å¼•è¨˜éŒ²ã‚’å‰Šé™¤
                transactions = transactions.filter(t => t.productId !== productId);
                
                // å•†å“ã‚’å‰Šé™¤
                products = products.filter(p => p.id !== productId);
                
                renderProductsTable();
                renderTransactionsTable();
                updateProductSelect();
                updateDashboardStats();
                updateMonthlyReport();
                
                // è‡ªå‹•ä¿å­˜
                if (isCloudMode) {
                    saveToCloud();
                } else {
                    saveAllData();
                }
                
                alert('å•†å“ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
            }
        }

        // ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†é–¢é€£
        function renderStaffTable() {
            const tbody = document.getElementById('staffTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';

            staff.forEach(member => {
                const row = tbody.insertRow();
                const roleStyles = {
                    'åº—é•·': 'background: #a855f7; color: white;',
                    'ã‚¹ã‚¿ã‚¤ãƒªã‚¹ãƒˆ': 'background: #3b82f6; color: white;',
                    'ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ': 'background: #10b981; color: white;',
                    'ã‚¹ã‚¿ãƒƒãƒ•': 'background: #10b981; color: white;'
                };

                row.innerHTML = `
                    <td>${member.staffCode}</td>
                    <td>${member.name}</td>
                    <td><span class="status-badge" style="${roleStyles[member.role]}">${member.role}</span></td>
                    <td><span class="status-badge status-optimal">åœ¨ç±</span></td>
                    <td>${member.joinDate || new Date().toISOString().split('T')[0]}</td>
                    <td>
                        <button class="btn" onclick="deleteStaff(${member.id})" style="background: #dc2626; color: white; padding: 6px 12px; font-size: 0.8rem;">å‰Šé™¤</button>
                    </td>
                `;
            });
        }

        function deleteStaff(staffId) {
            const member = staff.find(s => s.id === staffId);
            if (!member) return;
            
            if (confirm(`ã€Œ${member.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                staff = staff.filter(s => s.id !== staffId);
                renderStaffTable();
                updateStaffSelect();
                
                // è‡ªå‹•ä¿å­˜
                if (isCloudMode) {
                    saveToCloud();
                } else {
                    saveAllData();
                }
                
                alert('ã‚¹ã‚¿ãƒƒãƒ•ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
            }
        }

        // å–å¼•è¨˜éŒ²é–¢é€£
        function showAddTransactionForm() {
            const form = document.getElementById('addTransactionForm');
            if (form) form.classList.remove('hidden');
        }

        function hideAddTransactionForm() {
            const form = document.getElementById('addTransactionForm');
            if (form) form.classList.add('hidden');
            clearTransactionForm();
        }

        function clearTransactionForm() {
            const elements = ['transactionProduct', 'transactionQuantity', 'transactionStaff', 'transactionMemo'];
            elements.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            
            const type = document.getElementById('transactionType');
            if (type) type.value = 'order';
        }

        function addTransaction() {
            const productIdValue = document.getElementById('transactionProduct').value;
            const type = document.getElementById('transactionType').value;
            const quantity = parseInt(document.getElementById('transactionQuantity').value);
            const staffName = document.getElementById('transactionStaff').value;
            const memo = document.getElementById('transactionMemo').value;

            if (!productIdValue || !quantity || !staffName) {
                alert('å•†å“ãƒ»æ•°é‡ãƒ»æ‹…å½“è€…ã¯å¿…é ˆã§ã™ã€‚');
                return;
            }

            const productId = parseInt(productIdValue);
            const now = new Date();
            const date = now.toISOString().split('T')[0];
            const time = now.toTimeString().slice(0, 5);

            const newTransaction = {
                id: Date.now(),
                productId: productId,
                type: type,
                quantity: quantity,
                date: date,
                time: time,
                staffName: staffName,
                memo: memo
            };

            transactions.unshift(newTransaction);

            // åœ¨åº«æ•°ã‚’æ›´æ–°
            const selectedProduct = products.find(p => parseInt(p.id) === productId);
            if (selectedProduct) {
                if (type === 'receipt') {
                    selectedProduct.currentStock += quantity;
                } else if (type === 'use' || type === 'sale') {
                    selectedProduct.currentStock = Math.max(0, selectedProduct.currentStock - quantity);
                }
                renderProductsTable();
                updateDashboardStats();
            }

            hideAddTransactionForm();
            renderTransactionsTable();
            updateMonthlyReport();
            
            // è‡ªå‹•ä¿å­˜
            if (isCloudMode) {
                saveToCloud();
            } else {
                saveAllData();
            }
            
            alert('å–å¼•ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼');
        }

        function renderTransactionsTable() {
            const tbody = document.getElementById('transactionsTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';

            const typeStyles = {
                order: 'background: #3b82f6; color: white;',
                receipt: 'background: #10b981; color: white;',
                use: 'background: #f59e0b; color: white;',
                sale: 'background: #8b5cf6; color: white;'
            };

            const typeLabels = {
                order: 'ç™ºæ³¨',
                receipt: 'å…¥è·',
                use: 'ä½¿ç”¨',
                sale: 'è²©å£²'
            };

            transactions.forEach(transaction => {
                const row = tbody.insertRow();
                row.setAttribute('data-transaction-id', transaction.id);

                if (editingTransactionId === transaction.id) {
                    // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼ˆç°¡ç•¥ç‰ˆï¼‰
                    row.innerHTML = `
                        <td>${transaction.date}<br><small>${transaction.time}</small></td>
                        <td>ç·¨é›†ä¸­...</td>
                        <td>ç·¨é›†ä¸­...</td>
                        <td>ç·¨é›†ä¸­...</td>
                        <td>ç·¨é›†ä¸­...</td>
                        <td>ç·¨é›†ä¸­...</td>
                        <td>
                            <button class="btn" onclick="cancelTransactionEdit()" style="background: #6c757d; color: white; padding: 4px 8px; font-size: 0.7rem;">å–æ¶ˆ</button>
                        </td>
                    `;
                } else {
                    // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰
                    const relatedProduct = products.find(p => parseInt(p.id) === parseInt(transaction.productId));
                    const productName = relatedProduct ? relatedProduct.name : `å‰Šé™¤ã•ã‚ŒãŸå•†å“ (ID: ${transaction.productId})`;

                    row.innerHTML = `
                        <td>${transaction.date}<br><small>${transaction.time}</small></td>
                        <td>${productName}</td>
                        <td><span class="status-badge" style="${typeStyles[transaction.type]}">${typeLabels[transaction.type]}</span></td>
                        <td>${transaction.quantity}</td>
                        <td>${transaction.staffName}</td>
                        <td>${transaction.memo}</td>
                        <td>
                            <button class="btn" onclick="editTransaction(${transaction.id})" style="background: #3b82f6; color: white; padding: 4px 8px; font-size: 0.7rem; margin-right: 3px;">ä¿®æ­£</button>
                            <button class="btn" onclick="deleteTransaction(${transaction.id})" style="background: #dc2626; color: white; padding: 4px 8px; font-size: 0.7rem;">å‰Šé™¤</button>
                        </td>
                    `;
                }
            });
        }

        function editTransaction(transactionId) {
            editingTransactionId = transactionId;
            renderTransactionsTable();
        }

        function cancelTransactionEdit() {
            editingTransactionId = null;
            renderTransactionsTable();
        }

        function deleteTransaction(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) return;

            const relatedProduct = products.find(p => parseInt(p.id) === parseInt(transaction.productId));
            const productName = relatedProduct ? relatedProduct.name : `å‰Šé™¤ã•ã‚ŒãŸå•†å“ (ID: ${transaction.productId})`;

            if (confirm(`ã“ã®å–å¼•è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nå•†å“: ${productName}\nç¨®åˆ¥: ${getTypeLabel(transaction.type)}\næ•°é‡: ${transaction.quantity}\n\nâ€»åœ¨åº«æ•°ã‚‚è‡ªå‹•èª¿æ•´ã•ã‚Œã¾ã™`)) {
                // åœ¨åº«ã‚’å…ƒã«æˆ»ã™
                if (relatedProduct) {
                    if (transaction.type === 'receipt') {
                        relatedProduct.currentStock = Math.max(0, relatedProduct.currentStock - transaction.quantity);
                    } else if (transaction.type === 'use' || transaction.type === 'sale') {
                        relatedProduct.currentStock += transaction.quantity;
                    }
                }

                transactions = transactions.filter(t => t.id !== transactionId);

                renderTransactionsTable();
                renderProductsTable();
                updateDashboardStats();
                updateMonthlyReport();
                
                // è‡ªå‹•ä¿å­˜
                if (isCloudMode) {
                    saveToCloud();
                } else {
                    saveAllData();
                }

                alert('å–å¼•è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
            }
        }

        function getTypeLabel(type) {
            const typeLabels = {
                order: 'ç™ºæ³¨',
                receipt: 'å…¥è·',
                use: 'ä½¿ç”¨',
                sale: 'è²©å£²'
            };
            return typeLabels[type] || type;
        }

        // æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆé–¢é€£
        function calculateMonthlyReport() {
            const currentMonth = new Date().toISOString().slice(0, 7);
            
            const monthlyTransactions = transactions.filter(t => 
                t.type === 'order' && 
                t.date.startsWith(currentMonth)
            );

            let totalAmount = 0;
            const supplierTotals = {};
            const supplierCounts = {};
            const supplierQuantities = {};
            const transactionDetails = [];

            monthlyTransactions.forEach(transaction => {
                const relatedProduct = products.find(p => parseInt(p.id) === parseInt(transaction.productId));
                if (relatedProduct && relatedProduct.unitPrice > 0 && relatedProduct.supplier) {
                    const amount = transaction.quantity * relatedProduct.unitPrice;
                    totalAmount += amount;

                    const supplier = relatedProduct.supplier;
                    if (!supplierTotals[supplier]) {
                        supplierTotals[supplier] = 0;
                        supplierCounts[supplier] = 0;
                        supplierQuantities[supplier] = 0;
                    }
                    supplierTotals[supplier] += amount;
                    supplierCounts[supplier]++;
                    supplierQuantities[supplier] += transaction.quantity;

                    transactionDetails.push({
                        date: transaction.date,
                        time: transaction.time,
                        productName: relatedProduct.name,
                        type: transaction.type,
                        quantity: transaction.quantity,
                        unitPrice: relatedProduct.unitPrice,
                        amount: amount,
                        staffName: transaction.staffName,
                        memo: transaction.memo
                    });
                }
            });

            return {
                totalAmount,
                supplierCount: Object.keys(supplierTotals).length,
                transactionCount: monthlyTransactions.length,
                supplierTotals,
                supplierCounts,
                supplierQuantities,
                transactionDetails
            };
        }

        function updateMonthlyReport() {
            const report = calculateMonthlyReport();

            const amountElement = document.getElementById('monthly-amount');
            const supplierElement = document.getElementById('supplier-count');
            const transactionElement = document.getElementById('transaction-count');
            const lastUpdateElement = document.getElementById('last-update');

            if (amountElement) amountElement.textContent = `Â¥${report.totalAmount.toLocaleString()}`;
            if (supplierElement) supplierElement.textContent = report.supplierCount;
            if (transactionElement) transactionElement.textContent = report.transactionCount;
            if (lastUpdateElement) {
                const now = new Date();
                lastUpdateElement.textContent = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
            }

            const tbody = document.getElementById('supplier-report-tbody');
            if (tbody) {
                tbody.innerHTML = '';
                
                const sortedSuppliers = Object.entries(report.supplierTotals)
                    .sort(([,a], [,b]) => b - a);

                sortedSuppliers.forEach(([supplier, amount]) => {
                    const percentage = report.totalAmount > 0 ? (amount / report.totalAmount * 100).toFixed(1) : 0;
                    const count = report.supplierCounts[supplier];
                    const quantity = report.supplierQuantities[supplier];
                    const avgPrice = quantity > 0 ? Math.round(amount / quantity) : 0;
                    
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>
                            <strong>${supplier}</strong><br>
                            <small style="color: #6c757d;">${quantity}å€‹ç™ºæ³¨</small>
                        </td>
                        <td>Â¥${amount.toLocaleString()}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span>${percentage}%</span>
                                <div style="width: 50px; height: 6px; background: #e9ecef; border-radius: 3px;">
                                    <div style="width: ${percentage}%; height: 100%; background: #8b5cf6; border-radius: 3px;"></div>
                                </div>
                            </div>
                        </td>
                        <td>${count}å›</td>
                        <td>Â¥${avgPrice.toLocaleString()}</td>
                    `;
                });

                if (sortedSuppliers.length === 0) {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td colspan="5" style="text-align: center; color: #6c757d; font-style: italic; padding: 40px;">
                            <div style="font-size: 3rem; margin-bottom: 15px;">ğŸ“Š</div>
                            <div style="font-size: 1.1rem; margin-bottom: 5px;">å½“æœˆã®ç™ºæ³¨ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
                            <div style="font-size: 0.9rem;">ç™ºæ³¨å–å¼•ã‚’è¿½åŠ ã™ã‚‹ã¨è‡ªå‹•çš„ã«é›†è¨ˆã•ã‚Œã¾ã™</div>
                        </td>
                    `;
                }
            }
        }

        function showTransactionDetails() {
            const report = calculateMonthlyReport();
            const modal = document.getElementById('transactionDetailModal');
            const content = document.getElementById('transactionDetailContent');

            if (!modal || !content) return;

            content.innerHTML = '';

            if (report.transactionDetails.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6c757d;">
                        <div style="font-size: 3rem; margin-bottom: 15px;">ğŸ“Š</div>
                        <div>å½“æœˆã®ç™ºæ³¨ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
                    </div>
                `;
            } else {
                const sortedTransactions = report.transactionDetails.sort((a, b) => {
                    const dateTimeA = new Date(`${a.date} ${a.time}`);
                    const dateTimeB = new Date(`${b.date} ${b.time}`);
                    return dateTimeB - dateTimeA;
                });

                sortedTransactions.forEach(transaction => {
                    const item = document.createElement('div');
                    item.className = 'transaction-item';
                    item.innerHTML = `
                        <div>
                            <strong>${transaction.productName}</strong>
                            <div style="font-size: 0.8rem; color: #6c757d;">
                                ${transaction.date} ${transaction.time} | ç™ºæ³¨ | ${transaction.staffName}
                            </div>
                            ${transaction.memo ? `<div style="font-size: 0.8rem; color: #6c757d;">${transaction.memo}</div>` : ''}
                        </div>
                        <div style="text-align: right;">
                            <div><strong>${transaction.quantity}å€‹</strong></div>
                            <div style="color: #8b5cf6;">Â¥${transaction.amount.toLocaleString()}</div>
                        </div>
                    `;
                    content.appendChild(item);
                });
            }

            modal.classList.add('show');
        }

        function closeTransactionDetailModal() {
            const modal = document.getElementById('transactionDetailModal');
            if (modal) modal.classList.remove('show');
        }

        // é¸æŠè‚¢æ›´æ–°
        function updateProductSelect() {
            const select = document.getElementById('transactionProduct');
            if (!select) return;
            
            select.innerHTML = '<option value="">å•†å“ã‚’é¸æŠ</option>';
            
            products.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = product.name;
                select.appendChild(option);
            });
        }

        function updateStaffSelect() {
            const select = document.getElementById('transactionStaff');
            if (!select) return;
            
            select.innerHTML = '<option value="">æ‹…å½“è€…ã‚’é¸æŠ</option>';
            
            staff.forEach(member => {
                const option = document.createElement('option');
                option.value = member.name;
                option.textContent = member.name;
                select.appendChild(option);
            });
        }

        // CSVé–¢é€£æ©Ÿèƒ½
        function showCsvModal(type) {
            currentCsvType = type;
            setCsvType(type);
            const modal = document.getElementById('csvModal');
            if (modal) modal.classList.add('show');
        }

        function closeCsvModal() {
            const modal = document.getElementById('csvModal');
            if (modal) modal.classList.remove('show');
            clearCsvData();
        }

        function setCsvType(type) {
            currentCsvType = type;
            
            const productBtn = document.getElementById('productTypeBtn');
            const staffBtn = document.getElementById('staffTypeBtn');
            const templateInfo = document.getElementById('templateInfo');
            
            if (type === 'products') {
                if (productBtn) productBtn.className = 'btn btn-primary';
                if (staffBtn) {
                    staffBtn.className = 'btn';
                    staffBtn.style.background = '#6c757d';
                    staffBtn.style.color = 'white';
                }
                if (templateInfo) templateInfo.textContent = 'å•†å“ãƒã‚¹ã‚¿å¿…é ˆé …ç›®: name(å•†å“å), currentStock(ç¾åœ¨åº«), optimalStock(é©æ­£åœ¨åº«), supplier(ä»•å…¥ã‚Œå…ˆ) â€»unitPrice(å˜ä¾¡)ã¯ç©ºç™½å¯';
            } else {
                if (staffBtn) staffBtn.className = 'btn btn-primary';
                if (productBtn) {
                    productBtn.className = 'btn';
                    productBtn.style.background = '#6c757d';
                    productBtn.style.color = 'white';
                }
                if (templateInfo) templateInfo.textContent = 'ã‚¹ã‚¿ãƒƒãƒ•ãƒã‚¹ã‚¿å¿…é ˆé …ç›®: name(åå‰)';
            }
        }

        function downloadTemplate() {
            let csvContent = '';
            
            if (currentCsvType === 'products') {
                csvContent = 'name,category,currentStock,optimalStock,unitPrice,supplier\n';
                csvContent += 'ã‚µãƒ³ãƒ—ãƒ«å•†å“,ã‚«ãƒ©ãƒ¼å‰¤,10,20,1200,ã‚µãƒ³ãƒ—ãƒ«ä»•å…¥å…ˆ\n';
                csvContent += 'ãƒ­ãƒ¬ã‚¢ãƒ« ã‚«ãƒ©ãƒ¼å‰¤ 7ç•ª,ã‚«ãƒ©ãƒ¼å‰¤,5,15,1300,ãƒ­ãƒ¬ã‚¢ãƒ«\n';
            } else {
                csvContent = 'name,role,staffCode,joinDate\n';
                csvContent += 'ã‚µãƒ³ãƒ—ãƒ«å¤ªéƒ,ã‚¹ã‚¿ãƒƒãƒ•,ST1001,2025-01-01\n';
                csvContent += 'éˆ´æœ¨èŠ±å­,ã‚¹ã‚¿ã‚¤ãƒªã‚¹ãƒˆ,ST1002,2024-06-15\n';
            }

            // BOMä»˜ãã§æ–‡å­—åŒ–ã‘å¯¾ç­–
            const bom = '\uFEFF';
            const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${currentCsvType}_template.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file && file.type === 'text/csv') {
                parseCSV(file);
            } else {
                alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
            }
        }

        function parseCSV(file) {
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                dynamicTyping: true,
                encoding: 'UTF-8',
                complete: function(results) {
                    csvData = results.data;
                    validateAndPreview(csvData);
                },
                error: function(error) {
                    alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            });
        }

        function validateAndPreview(data) {
            validationErrors = [];
            const preview = [];

            if (currentCsvType === 'products') {
                validateProductData(data, preview);
            } else {
                validateStaffData(data, preview);
            }

            displayPreview(preview);
        }

        function validateProductData(data, preview) {
            const requiredFields = ['name', 'currentStock', 'optimalStock', 'supplier'];
            
            data.forEach((row, index) => {
                const errors = [];
                
                requiredFields.forEach(field => {
                    if (!row[field] && row[field] !== 0 && row[field] !== '') {
                        errors.push(`${field}ã¯å¿…é ˆã§ã™`);
                    }
                });

                if (row.currentStock && (isNaN(row.currentStock) || row.currentStock < 0)) {
                    errors.push('ç¾åœ¨åº«ã¯æ­£ã®æ•°å€¤ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™');
                }
                if (row.optimalStock && (isNaN(row.optimalStock) || row.optimalStock < 0)) {
                    errors.push('é©æ­£åœ¨åº«ã¯æ­£ã®æ•°å€¤ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™');
                }
                if (row.unitPrice && row.unitPrice !== '' && (isNaN(row.unitPrice) || row.unitPrice < 0)) {
                    errors.push('å˜ä¾¡ã¯æ­£ã®æ•°å€¤ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™');
                }

                if (errors.length > 0) {
                    validationErrors.push({
                        row: index + 1,
                        errors: errors
                    });
                }

                preview.push({
                    ...row,
                    hasErrors: errors.length > 0
                });
            });
        }

        function validateStaffData(data, preview) {
            const requiredFields = ['name'];
            
            data.forEach((row, index) => {
                const errors = [];
                
                requiredFields.forEach(field => {
                    if (!row[field] || row[field] === '') {
                        errors.push(`${field}ã¯å¿…é ˆã§ã™`);
                    }
                });

                if (errors.length > 0) {
                    validationErrors.push({
                        row: index + 1,
                        errors: errors
                    });
                }

                preview.push({
                    ...row,
                    hasErrors: errors.length > 0
                });
            });
        }

        function displayPreview(preview) {
            const previewDiv = document.getElementById('csvPreview');
            const errorDiv = document.getElementById('errorSummary');
            const errorDetails = document.getElementById('errorDetails');
            const previewHeader = document.getElementById('previewHeader');
            const previewBody = document.getElementById('previewBody');

            if (!previewDiv) return;

            // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
            if (validationErrors.length > 0 && errorDiv && errorDetails) {
                errorDiv.classList.remove('hidden');
                errorDetails.innerHTML = '';
                validationErrors.slice(0, 5).forEach(error => {
                    const errorItem = document.createElement('div');
                    errorItem.className = 'error-item';
                    errorItem.textContent = `è¡Œ${error.row}: ${error.errors.join(', ')}`;
                    errorDetails.appendChild(errorItem);
                });
                
                if (validationErrors.length > 5) {
                    const moreErrors = document.createElement('div');
                    moreErrors.className = 'error-item';
                    moreErrors.textContent = `ä»–${validationErrors.length - 5}ä»¶ã®ã‚¨ãƒ©ãƒ¼...`;
                    errorDetails.appendChild(moreErrors);
                }
            } else if (errorDiv) {
                errorDiv.classList.add('hidden');
            }

            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
            let headers = [];
            if (currentCsvType === 'products') {
                headers = ['çŠ¶æ…‹', 'å•†å“å', 'ç¾åœ¨åº«', 'é©æ­£åœ¨åº«', 'å˜ä¾¡', 'ä»•å…¥ã‚Œå…ˆ'];
            } else {
                headers = ['çŠ¶æ…‹', 'åå‰'];
            }

            if (previewHeader) {
                previewHeader.innerHTML = '';
                const headerRow = previewHeader.insertRow();
                headers.forEach(header => {
                    const th = document.createElement('th');
                    th.textContent = header;
                    headerRow.appendChild(th);
                });
            }

            if (previewBody) {
                previewBody.innerHTML = '';
                preview.forEach(row => {
                    const tr = previewBody.insertRow();
                    if (row.hasErrors) {
                        tr.style.background = '#fef2f2';
                    }

                    const statusCell = tr.insertCell();
                    statusCell.innerHTML = row.hasErrors ? 'âŒ' : 'âœ…';

                    if (currentCsvType === 'products') {
                        tr.insertCell().textContent = row.name || '';
                        tr.insertCell().textContent = row.currentStock || '0';
                        tr.insertCell().textContent = row.optimalStock || '';
                        tr.insertCell().textContent = row.unitPrice ? `Â¥${parseInt(row.unitPrice).toLocaleString()}` : 'Â¥0';
                        tr.insertCell().textContent = row.supplier || '';
                    } else {
                        tr.insertCell().textContent = row.name || '';
                    }
                });
            }

            // ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
            const importBtn = document.getElementById('importBtn');
            const importBtnText = document.getElementById('importBtnText');
            if (importBtn && importBtnText) {
                if (validationErrors.length > 0) {
                    importBtn.disabled = true;
                    importBtn.style.background = '#9ca3af';
                    importBtn.style.cursor = 'not-allowed';
                    importBtnText.textContent = 'ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„';
                } else {
                    importBtn.disabled = false;
                    importBtn.style.background = '';
                    importBtn.style.cursor = 'pointer';
                    importBtnText.textContent = `${preview.length}ä»¶ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ`;
                }
            }

            previewDiv.classList.remove('hidden');
        }

        function clearCsvData() {
            csvData = [];
            validationErrors = [];
            const previewDiv = document.getElementById('csvPreview');
            const csvFile = document.getElementById('csvFile');
            
            if (previewDiv) previewDiv.classList.add('hidden');
            if (csvFile) csvFile.value = '';
        }

        function importCsvData() {
            if (validationErrors.length > 0) {
                alert('ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹ãŸã‚ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ãã¾ã›ã‚“ã€‚');
                return;
            }

            let message = '';
            if (currentCsvType === 'products') {
                const maxId = products.length > 0 ? Math.max(...products.map(p => p.id)) : 0;
                
                csvData.forEach((row, index) => {
                    const newProduct = {
                        id: maxId + index + 1,
                        name: row.name,
                        category: row.category || 'ãã®ä»–',
                        currentStock: parseInt(row.currentStock) || 0,
                        optimalStock: parseInt(row.optimalStock) || 0,
                        unitPrice: parseInt(row.unitPrice) || 0,
                        supplier: row.supplier || ''
                    };
                    products.push(newProduct);
                });
                
                // IDã§ä¸¦ã³æ›¿ãˆ
                products.sort((a, b) => a.id - b.id);
                
                renderProductsTable();
                updateProductSelect();
                updateDashboardStats();
                updateMonthlyReport();
                message = `${csvData.length}ä»¶ã®å•†å“ã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚`;
            } else {
                const maxId = staff.length > 0 ? Math.max(...staff.map(s => s.id)) : 0;
                
                csvData.forEach((row, index) => {
                    const newStaff = {
                        id: maxId + index + 1,
                        name: row.name,
                        role: row.role || 'ã‚¹ã‚¿ãƒƒãƒ•',
                        staffCode: row.staffCode || `ST${(1000 + staff.length + index + 1).toString()}`,
                        joinDate: row.joinDate || new Date().toISOString().split('T')[0]
                    };
                    staff.push(newStaff);
                });
                
                // IDã§ä¸¦ã³æ›¿ãˆ
                staff.sort((a, b) => a.id - b.id);
                
                renderStaffTable();
                updateStaffSelect();
                message = `${csvData.length}ä»¶ã®ã‚¹ã‚¿ãƒƒãƒ•ã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚`;
            }

            // è‡ªå‹•ä¿å­˜
            if (isCloudMode) {
                saveToCloud();
            } else {
                saveAllData();
            }

            alert(message);
            closeCsvModal();
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
        function exportData() {
            try {
                const dataToExport = {
                    products: products,
                    staff: staff,
                    transactions: transactions,
                    exportedAt: new Date().toISOString(),
                    version: '1.0'
                };
                
                const jsonString = JSON.stringify(dataToExport, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `ç¾å®¹å®¤ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                alert('ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼');
            } catch (error) {
                alert('âŒ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\n' + error.message);
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        if (confirm(`ğŸ“‚ ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿ\n\nğŸ“¦ å•†å“: ${importedData.products?.length || 0}ä»¶\nğŸ‘¥ ã‚¹ã‚¿ãƒƒãƒ•: ${importedData.staff?.length || 0}ä»¶\nğŸ“‹ å–å¼•: ${importedData.transactions?.length || 0}ä»¶\n\nâš ï¸ ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚`)) {
                            
                            if (importedData.products) products = importedData.products;
                            if (importedData.staff) staff = importedData.staff;
                            if (importedData.transactions) transactions = importedData.transactions;
                            
                            renderProductsTable();
                            renderStaffTable();
                            renderTransactionsTable();
                            updateProductSelect();
                            updateStaffSelect();
                            updateDashboardStats();
                            updateMonthlyReport();
                            updateDataStats();
                            
                            // è‡ªå‹•ä¿å­˜
                            if (isCloudMode) {
                                saveToCloud();
                            } else {
                                saveAllData();
                            }
                            
                            alert('âœ… ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸï¼');
                        }
                    } catch (error) {
                        alert('âŒ ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\nãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n\nã‚¨ãƒ©ãƒ¼: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†
        function setupDragAndDrop() {
            const uploadZone = document.getElementById('uploadZone');
            if (!uploadZone) return;
            
            uploadZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('dragover');
            });

            uploadZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
            });

            uploadZone.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type === 'text/csv') {
                    parseCSV(files[0]);
                } else {
                    alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚');
                }
            });
        }

        // å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£
        function showConfirmModal(title, message, deleteAction) {
            const modal = document.getElementById('confirmModal');
            const titleEl = document.getElementById('confirmTitle');
            const messageEl = document.getElementById('confirmMessage');
            
            if (titleEl) titleEl.textContent = title;
            if (messageEl) messageEl.innerHTML = message;
            pendingDeleteAction = deleteAction;
            if (modal) modal.classList.add('show');
        }

        function closeConfirmModal() {
            const modal = document.getElementById('confirmModal');
            if (modal) modal.classList.remove('show');
            pendingDeleteAction = null;
        }

        function executeDelete() {
            if (pendingDeleteAction) {
                pendingDeleteAction();
                closeConfirmModal();
            }
        }

        // åˆæœŸåŒ–
        window.onload = function() {
            // ä¿å­˜æ¸ˆã¿ã®Firebaseè¨­å®šãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const savedConfig = localStorage.getItem('firebaseConfig');
            
            if (savedConfig) {
                try {
                    const config = JSON.parse(savedConfig);
                    firebase.initializeApp(config);
                    db = firebase.firestore();
                    isCloudMode = true;
                    
                    document.getElementById('firebaseSetup').style.display = 'none';
                    document.getElementById('loginContainer').style.display = 'flex';
                    updateCloudStatus('æ¥ç¶šæ¸ˆã¿', true);
                    
                } catch (error) {
                    console.error('Firebase initialization error:', error);
                    document.getElementById('firebaseSetup').style.display = 'flex';
                }
            } else {
                document.getElementById('firebaseSetup').style.display = 'flex';
            }
            
            // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—è¨­å®š
            setTimeout(setupDragAndDrop, 1000);
            
            updateSyncStats();
        };

        // OCRé–¢é€£ã®é–¢æ•°
        function showOCRModal() {
            const modal = document.getElementById('ocrModal');
            if (modal) {
                modal.classList.add('show');
                // ã‚¹ã‚¿ãƒƒãƒ•é¸æŠã‚’æ›´æ–°
                updateOCRStaffSelect();
            }
        }

        function closeOCRModal() {
            const modal = document.getElementById('ocrModal');
            if (modal) {
                modal.classList.remove('show');
                // ãƒªã‚»ãƒƒãƒˆ
                document.getElementById('ocrPreview').style.display = 'none';
                document.getElementById('ocrResults').style.display = 'none';
                document.getElementById('ocrLoading').style.display = 'none';
                ocrRecords = [];
            }
        }

        function selectImageFile() {
            document.getElementById('ocrFileInput').click();
        }

        function handleOCRFile(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('ocrPreview');
                    preview.innerHTML = `<img src="${e.target.result}" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">`;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
                
                // OCRå‡¦ç†é–‹å§‹
                processOCR(file);
            }
        }

        async function processOCR(imageFile) {
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            document.getElementById('ocrLoading').style.display = 'block';
            document.getElementById('ocrResults').style.display = 'none';
            
            try {
                // Tesseract.jsã§OCRå®Ÿè¡Œ
                const result = await Tesseract.recognize(
                    imageFile,
                    'jpn',  // æ—¥æœ¬èª
                    {
                        logger: m => {
                            console.log(m);
                            // é€²æ—è¡¨ç¤ºã‚‚å¯èƒ½
                            if (m.status === 'recognizing text') {
                                const percent = Math.round(m.progress * 100);
                                const loading = document.querySelector('#ocrLoading p');
                                if (loading) {
                                    loading.textContent = `ç”»åƒã‚’è§£æä¸­... ${percent}%`;
                                }
                            }
                        }
                    }
                );
                
                console.log('OCRçµæœ:', result.data.text);
                
                // ãƒ†ã‚­ã‚¹ãƒˆã‚’è§£æ
                const records = parseOCRText(result.data.text);
                
                // çµæœè¡¨ç¤º
                showOCRResults(records);
                
            } catch (error) {
                alert('èª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼: ' + error.message);
                console.error('OCR Error:', error);
            } finally {
                document.getElementById('ocrLoading').style.display = 'none';
            }
        }

        function parseOCRText(text) {
            const records = [];
            const lines = text.split('\n');
            
            // å„å•†å“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å®šç¾©
            const productPatterns = [
                { pattern: /ã‚«ãƒ©ãƒ¼å‰¤.*?6ç•ª.*?(\d+)/, name: 'ãƒ­ãƒ¬ã‚¢ãƒ« ã‚«ãƒ©ãƒ¼å‰¤ 6ç•ª' },
                { pattern: /ã‚«ãƒ©ãƒ¼å‰¤.*?8ç•ª.*?(\d+)/, name: 'ãƒ­ãƒ¬ã‚¢ãƒ« ã‚«ãƒ©ãƒ¼å‰¤ 8ç•ª' },
                { pattern: /ãƒŸãƒ«ãƒœãƒ³.*?ã‚·ãƒ£ãƒ³ãƒ—ãƒ¼.*?(\d+)/, name: 'ãƒŸãƒ«ãƒœãƒ³ ã‚·ãƒ£ãƒ³ãƒ—ãƒ¼' },
                { pattern: /ãƒˆãƒªãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆ.*?(\d+)/, name: 'ãƒˆãƒªãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆ' },
                { pattern: /ã‚¦ã‚¨ãƒ©.*?ãƒ‘ãƒ¼ãƒæ¶².*?(\d+)/, name: 'ã‚¦ã‚¨ãƒ© ãƒ‘ãƒ¼ãƒæ¶²' },
                { pattern: /N\.?\s*ã‚ªã‚¤ãƒ«.*?(\d+)/, name: 'N. ã‚ªã‚¤ãƒ«' }
            ];
            
            // å„è¡Œã‚’ãƒã‚§ãƒƒã‚¯
            lines.forEach(line => {
                productPatterns.forEach(({ pattern, name }) => {
                    const match = line.match(pattern);
                    if (match && match[1]) {
                        const quantity = parseInt(match[1]);
                        if (quantity > 0) {
                            // å®Ÿéš›ã®å•†å“IDã‚’æ¢ã™
                            const product = products.find(p => p.name === name);
                            if (product) {
                                records.push({
                                    productId: product.id,
                                    productName: product.name,
                                    quantity: quantity,
                                    recognized: true
                                });
                            }
                        }
                    }
                });
            });
            
            return records;
        }

        function showOCRResults(records) {
            ocrRecords = records;
            
            // ã‚¹ã‚¿ãƒƒãƒ•é¸æŠã‚’æ›´æ–°
            updateOCRStaffSelect();
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«ã«çµæœã‚’è¡¨ç¤º
            const tbody = document.getElementById('ocrTableBody');
            tbody.innerHTML = '';
            
            records.forEach((record, index) => {
                addOCRTableRow(record, index);
            });
            
            // èªè­˜ã•ã‚Œãªã‹ã£ãŸå ´åˆã¯ç©ºè¡Œã‚’è¿½åŠ 
            if (records.length === 0) {
                addOCRRow();
            }
            
            document.getElementById('ocrResults').style.display = 'block';
        }

        function addOCRTableRow(record, index) {
            const tbody = document.getElementById('ocrTableBody');
            const row = tbody.insertRow();
            
            row.innerHTML = `
                <td>
                    <select id="ocr-product-${index}" class="form-control" style="width: 200px;">
                        <option value="">å•†å“ã‚’é¸æŠ</option>
                        ${products.map(p => `
                            <option value="${p.id}" ${record && record.productId === p.id ? 'selected' : ''}>
                                ${p.name}
                            </option>
                        `).join('')}
                    </select>
                </td>
                <td>
                    <input type="number" id="ocr-qty-${index}" class="form-control" 
                           value="${record ? record.quantity : 1}" min="1" style="width: 80px;">
                </td>
                <td>æœ¬</td>
                <td>
                    <button class="btn" onclick="removeOCRRow(${index})" 
                            style="background: #dc2626; color: white; padding: 4px 8px; font-size: 0.8rem;">
                        å‰Šé™¤
                    </button>
                </td>
            `;
        }

        function addOCRRow() {
            const newIndex = document.querySelectorAll('#ocrTableBody tr').length;
            addOCRTableRow(null, newIndex);
        }

        function removeOCRRow(index) {
            const tbody = document.getElementById('ocrTableBody');
            tbody.deleteRow(index);
            
            // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å†èª¿æ•´
            const rows = tbody.querySelectorAll('tr');
            rows.forEach((row, newIndex) => {
                // IDå±æ€§ã‚’æ›´æ–°
                const select = row.querySelector('select');
                const input = row.querySelector('input[type="number"]');
                const button = row.querySelector('button');
                
                if (select) select.id = `ocr-product-${newIndex}`;
                if (input) input.id = `ocr-qty-${newIndex}`;
                if (button) button.setAttribute('onclick', `removeOCRRow(${newIndex})`);
            });
        }

        function updateOCRStaffSelect() {
            const select = document.getElementById('ocrStaffSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
            staff.forEach(member => {
                const option = document.createElement('option');
                option.value = member.name;
                option.textContent = member.name;
                select.appendChild(option);
            });
        }

        function confirmOCRRecords() {
            const staffName = document.getElementById('ocrStaffSelect').value;
            if (!staffName) {
                alert('æ‹…å½“ã‚¹ã‚¿ãƒƒãƒ•ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            const records = [];
            const rows = document.querySelectorAll('#ocrTableBody tr');
            
            rows.forEach((row, index) => {
                const productId = document.getElementById(`ocr-product-${index}`).value;
                const quantity = parseInt(document.getElementById(`ocr-qty-${index}`).value);
                
                if (productId && quantity > 0) {
                    records.push({
                        productId: parseInt(productId),
                        quantity: quantity
                    });
                }
            });
            
            if (records.length === 0) {
                alert('è¨˜éŒ²ã™ã‚‹å•†å“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            
            // ç¢ºèª
            const confirmMessage = records.map(r => {
                const product = products.find(p => p.id === r.productId);
                return `${product.name}: ${r.quantity}æœ¬`;
            }).join('\n');
            
            if (confirm(`ä»¥ä¸‹ã®å†…å®¹ã§è¨˜éŒ²ã—ã¾ã™ã‹ï¼Ÿ\n\næ‹…å½“: ${staffName}\n\n${confirmMessage}`)) {
                // å–å¼•è¨˜éŒ²ã¨ã—ã¦è¿½åŠ 
                const now = new Date();
                const date = now.toISOString().split('T')[0];
                const time = now.toTimeString().slice(0, 5);
                
                records.forEach(record => {
                    const newTransaction = {
                        id: Date.now() + Math.random(), // ãƒ¦ãƒ‹ãƒ¼ã‚¯ID
                        productId: record.productId,
                        type: 'use',
                        quantity: record.quantity,
                        date: date,
                        time: time,
                        staffName: staffName,
                        memo: 'OCRèª­ã¿å–ã‚Š'
                    };
                    
                    transactions.unshift(newTransaction);
                    
                    // åœ¨åº«ã‚’æ›´æ–°
                    const product = products.find(p => p.id === record.productId);
                    if (product) {
                        product.currentStock = Math.max(0, product.currentStock - record.quantity);
                    }
                });
                
                // UIæ›´æ–°
                renderTransactionsTable();
                renderProductsTable();
                updateDashboardStats();
                updateMonthlyReport();
                
                // è‡ªå‹•ä¿å­˜
                if (isCloudMode) {
                    saveToCloud();
                } else {
                    saveAllData();
                }
                
                alert('è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
                closeOCRModal();
            }
        }

        function printOCRTemplate() {
            const printWindow = window.open('', '_blank');
            const template = document.getElementById('ocrPrintTemplate').innerHTML;
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>åœ¨åº«ä½¿ç”¨è¨˜éŒ²ã‚·ãƒ¼ãƒˆ</title>
                    <style>
                        @page { margin: 20mm; }
                        body { margin: 0; }
                        ${document.querySelector('style').textContent}
                    </style>
                </head>
                <body>
                    ${template}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.onload = function() {
                printWindow.print();
                printWindow.close();
            };
        }
    </script>
</body>
</html>